<!DOCTYPE HTML>
<meta charset="utf-8">
<title>MRC BROKEN TITLE</title>
<link rel="icon" type="image/x-icon" href="source/eyes.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

<style>
body{
	width:100%;
	height:100%;
	margin: 0;
}

html, body, input, button, select, div, text{
	font-family: Consolas, monospace;
}

img{
	image-rendering: pixelated;
}

*:not(input)::selection{
	background: currentBackgroundColor;
	color     : currentColor;
}

button:not(:disabled), select{
	cursor: pointer;
}

/* =================================== */

#WORKSPACE{
	display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    gap: 10px;
	width:50vw;
	height:100vh;
	cursor:grab;
	box-sizing: border-box;
	z-index:5;
	text-shadow: 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white;
}

#WORKSPACE-INFO{
	display: inherit;
}
</style>

<body>
	<div style="position:fixed; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content: center; align-items: center; color:white; font-size:2em; flex-direction:column; display:none;" id="LOADING">?</div>
	<div style="width:100%; height:100%; display: flow-root;" id="BODY"></div>
	<input type="file" id="FILE_PROJECT_INPUT" accept=".mrc-proj" style="display: none;">
	<input type="file" id="FILE_INPUT" style="display: none;">
	<input type="file" id="FILE_REPLACE" style="display: none;">
</body>

<script>
// ПАК

// Название пака
var P_NAME = "New MRC Project";
// Автор пака
var P_AUTHOR = "";
// Лицензия пака
var P_LICENSE = "";

// Категории
var P_CATEGORIES = ["Без категории"];
// Файлы
var P_FILES = {};

//===========================================
// САЙТ

const VERSION = "3";

var errorhas = false;
function detecterror(){
	if(!errorhas){
		errorhas = true;
		alert("Произошла какая-то ошибка! СМ. консоль - F12");
	}
}
window.addEventListener("error", (e) => {
	detecterror();
});

function stackline(){ const err = new Error(); var line = err.stack.split('\n')[2]; const match = line.match(/\d+:\d+/g); if(match){ return `${match[0]}`; } return line; }
function log  (message){ var m = message;  message = `${message} <${stackline()}>`; console.log  (typeof m === "object" ? m : message);                }
function warn (message){ message = `${message} <${stackline()}>`; console.warn ("%c%s", "color: yellow; font-weight: bold;" , message);                }
function error(message){ message = `${message} <${stackline()}>`; console.error("%c%s", "color: red; font-weight: bold;"    , message); detecterror(); }
function fatal(message){ message = `${message} <${stackline()}>`; const style = "color: white; background-color: red; font-weight: bold; padding: 4px; border-radius: 4px;"; console.error("%c%s", style, message); alert("Fatal: " + message); }

const BODY = document.getElementById("BODY");

/* Проект сохранён? */
var SAVED = true;

const FileExtension_Project  = ".mrc-proj";
const FileExtension_Compiled = ".mrc"     ;
var CurrentPage = "";

const PAGE_STARTPAGE =
`<center id="STARTPAGE" style="width:100vw; height:100vh;">
	<br>
	<text style="font-size:3em;">MRC ${VERSION}</text>
	<br><br>
	<button onclick="editor_create();" title="Создать новый пустой проект">Создать</button>
	<br>
<button onclick="editor_open();" title="Так же можно перетаскиванием">Открыть</button>
</center>`;

const PAGE_EDITOR =
`<panel style="position:fixed; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:1000; display:none;" id="TOOL-WINDOW"></panel>
<div style="display: flex; background-color:lightgray; background-image:url('source/grid2.png'); image-rendering: pixelated;" id="PAGE">
	<panel style="position:fixed; width: 5px; height: 5px; pointer-events: none;" id="WORKSPACE-CONTENT"></panel>
	<panel style="display:block; width:25vw; height:100vh; background-color:white; border-right:3px solid black; z-index:5;">
		<center style="height:100%;">
			<button style="margin-top:20px;" onclick="editor_open_project_settings();">Настройки проекта</button>
			<br>
			<button onclick="editor_open_project_files();">Файлы</button>
			<br><br>
			<div style="background-color:rgba(0,0,0,0.25); width:95%; height:80%;" id="TOOL"></div>
			<br><br>
			<button onclick="editor_save();" id="SAVE" disabled>Сохранить</button>
			<br>
			<button onclick="fatal('в разработке!!!');">Скомпилировать</button>
		</center>
	</panel>
	<panel id="WORKSPACE">
		<!-- L/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: flex-start;">
			<text id="I-MS">?</text>
		</panel>

		<!-- C/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: center;    ">
			<text style="color:lime;">+Y</text>
		</panel>

		<!-- R/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: flex-end;  ">
			<text>X: <input id="I-POS-X" type="number" step="1" pattern="\d*" value="0"></text>
			<text>Y: <input id="I-POS-Y" type="number" step="1" pattern="\d*" value="0"></text>
			<text>S: <input id="I-SCALE" type="number" step="0.0001" value="1"></text>
			<button onclick="editor_moveworkspace(); editor_scaleworkspace();">HOME</button>
		</panel>

		<!-- L/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: flex-start;">
			<text style="color:red;">-X</text>
		</panel>

		<!-- C/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: center;    "></panel>

		<!-- R/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: flex-end;  ">
			<text style="color:red;">+X</text>
		</panel>

		<!-- L/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: flex-start;">
			<text id="I-IN-EDIT">?</text>
		</panel>

		<!-- C/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: center;    ">
			<text style="color:lime;">-Y</text>
		</panel>

		<!-- R/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: flex-end;  ">
		</panel>
	</panel>
	<panel style="display:block; width:25vw; height:100vh; background-color:white; border-left:3px solid black; z-index:5;">

	</panel>
</div>`;

function editor_create(){
	page("e");
}

const FILE_PROJECT_INPUT = document.getElementById("FILE_PROJECT_INPUT");
function editor_open_project(ProjectFile){
	if(ProjectFile.name.endsWith(FileExtension_Project)){
		log(`Попытка открытия проекта [${ProjectFile.name}]!`);
		editor_load(ProjectFile);
	}else{
		fatal(`Выбранный файл в виде проекта, не является с форматом "${FileExtension_Project}"!\nFILE_PROJECT_INPUT->change(${ProjectFile.name});`);
	}
}
FILE_PROJECT_INPUT.addEventListener("change", function(e) {
	if(e.target.files.length > 0){
		if(e.target.files.length === 1){
			editor_open_project(e.target.files[0]);
		}else{
			fatal(`Выбрано несколько проектов! Нужно выбрать 1!\nFILE_PROJECT_INPUT->change(${ProjectFile.name});`);
		}
	}
});
document.addEventListener("dragover", (e) => {
	e.preventDefault();
});
document.addEventListener("drop", (e) => {
	e.preventDefault();
	if(CurrentPage===""){
		editor_open_project(e.dataTransfer.files[0]);
	}
});

function editor_open(){
	FILE_PROJECT_INPUT.click();
}

function refresh_title(){
	var result = `MRC ${VERSION}`;
	
	if(!SAVED){ result += "*"; }
	
	document.title = result;
}
refresh_title();

function editor_make_unsave(){
	if(SAVED){
		SAVED = false;
		
		document.getElementById("SAVE").disabled = false;
		refresh_title();
	}
}

function get_png_dimension(content){
	return new Promise((resolve, reject) => {
		const blob = new Blob([content], { type: "image/png" });
		const url = URL.createObjectURL(blob);
		const img = new Image();
		img.onload = function(){
			URL.revokeObjectURL(url);
			const dimension = [img.width, img.height];
			URL.revokeObjectURL(url);
			resolve(dimension);
		}
		img.onerror = function(){
			URL.revokeObjectURL(url);
			reject(new Error("Не удалось получить размер изображения!"));
		}
		
		img.src = url;
	});
}

async function editor_save(){
	if(!SAVED){
		var loading = document.getElementById("LOADING");
		loading.innerHTML = 
		`<text>Сохраняется...</text>
		<text style="color:transparent;">.</text>
		<text>Добавлено файлов: <text id="LOADING-PROGRESS">?</text> / <text id="LOADING-PROGRESS-TOTAL">?</text></text>
		<text>Сжимается: <text id="LOADING-PROGRESS-ZIP">?</text>%</text>
		<text>(<text id="LOADING-PROGRESS-FILE">?</text>)</text>`;
		loading.style.display = "flex";
		try{
			function checkstring(s,sn,ifempty = null){ if(!s || s.trim()===""){ if(ifempty!=null){ return ifempty; }else{ throw new Error(`строка "${sn}" пустая!`); } } return s; }
		
			checkstring(P_NAME   ,"Название проекта");
			P_AUTHOR  = checkstring(P_AUTHOR ,"Автор проекта"   ,"Anonymous"    );
			P_LICENSE = checkstring(P_LICENSE,"Лицензия проекта","Not specified");
		
			const zip = new JSZip();
			
			var zip_content_result = [];
			
			//CONTENT ->
			
			const content = zip.folder("Content");
			
			var files = {};
			
			for(var category in P_FILES){
				files[category] = [];
				var category_folder = content.folder(category);
				for(var i = 0; i < P_FILES[category].length; i++){
					var file = { ...P_FILES[category][i] };
					var file_content = file["Content"];
					if(file["ContentType"]==="byte"){
						file_content = new Uint8Array(file_content);
					}
					delete file["Content"  ];
					delete file["Size"     ];
					delete file["Dimension"];
					delete file["URL"      ];
					delete file["Category" ];
					zip_content_result.push([category_folder,file["Name"],file_content]);
					files[category].push(file);
				}
			}
			
			zip_content_result.push([zip,"ProjectSettings", JSON.stringify({
				"Name": P_NAME,
				"Author": P_AUTHOR,
				"License": P_LICENSE,
				"MRC_Version": VERSION,
				"Categories": P_CATEGORIES,
				"Files": files
			}, null, 2)]);
			
			//<-
			
			async function createzip(){
				const totalfiles = zip_content_result.length;
				document.getElementById("LOADING-PROGRESS-TOTAL").innerText = totalfiles;
				var addedfiles = 0;
				
				const loadingprogess = document.getElementById("LOADING-PROGRESS");
				for(var i = 0; i < totalfiles; i++){
					var file = zip_content_result[i];
					file[0].file(file[1],file[2]);
					addedfiles++;
					loadingprogess.innerText = addedfiles;
				}
			}
			
			async function createzip2(){
				const loadingprogess = document.getElementById("LOADING-PROGRESS-ZIP");
				const loadingprogess2 = document.getElementById("LOADING-PROGRESS-FILE");
				
				const zip_content = await zip.generateAsync({
					type: "blob",
					compression: "DEFLATE",
					compressionOptions: { level: 6 }
				}, function updateCallback(metadata){
					const currentfile = metadata.currentFile || "Все файлы загружены!";
					loadingprogess2.innerText = currentfile;
					loadingprogess.innerText = metadata.percent.toFixed(2);
				});
				
				return zip_content;
			}
			
			createzip().then(() => { return createzip2(); }).then((zip_content) => {
				const url = URL.createObjectURL(zip_content);
				const a = document.createElement("a");
				a.href = url;
				a.download = P_NAME + FileExtension_Project;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			
				SAVED = true;
				
				document.getElementById("SAVE").disabled = true;
				refresh_title();
				loading.style.display = "none";
			})
		}catch(e){
			loading.style.display = "none";
			fatal(`Не получилось сохранить проект, ${e}`);
		}
	}
}

async function editor_load(file){
	var loading = document.getElementById("LOADING");
	loading.innerHTML = 
	`<text>Загружается...</text>`;
	loading.style.display = "flex";
	try{
		const zip = await JSZip.loadAsync(file);
		
		async function checkfile(f,s){ if(!f){ throw new Error(`Файл "${s}" не найден!`); } var c = await f.async("text"); return c; }
		function checkkey(tabl,k,notfound = "NotFound"){ if(!tabl[k]){ warn(`Не найден ключ "${k}" в файле!`); return notfound; } return tabl[k]; }
		
		const ProjectSettings_File = zip.file("ProjectSettings");
		const ProjectSettings_Content = await checkfile(ProjectSettings_File, "ProjectSettings");
		const ProjectSettings = JSON.parse(ProjectSettings_Content);
		
		log("Настройки проекта:");
		log(ProjectSettings);
		
		var MRC_Version = checkkey(ProjectSettings,"MRC_Version","-1");
		if(MRC_Version!==VERSION){ fatal(`Версия проекта отличается от новой версии, возможны ошибки! ${MRC_Version} != ${VERSION}`); }
		
		P_NAME    = checkkey(ProjectSettings,"Name");
		P_AUTHOR  = checkkey(ProjectSettings,"Author");
		P_LICENSE = checkkey(ProjectSettings,"License");
		P_CATEGORIES = checkkey(ProjectSettings,"Categories",["NotFound"]);
		
		var files_all = checkkey(ProjectSettings,"Files",{});
		P_FILES = {};
		var content = zip.folder("Content");
		async function processFiles() {
			for (var category in files_all) {
				if (P_CATEGORIES.includes(category)) {
					P_FILES[category] = [];
					var category_folder = content.folder(category);
					var files = files_all[category];

					var promises = files.map(async (file) => {
						var file_content = file["ContentType"] === "text" ? await category_folder.file(file["Name"]).async("text") : await category_folder.file(file["Name"]).async("uint8array");

						file["URL"     ] = null;
						file["Content" ] = file_content;
						file["Size"    ] = file["ContentType"] === "byte" ? file_content.byteLength : file_content.length;
						file["Category"] = category;

						if (file["Type"] === "texture") {
							try {
								var dimension = await get_png_dimension(file_content);
								file["Dimension"] = dimension;
							} catch (e) {
								console.error(`Не получилось определить размер изображения [${file["Name"]}]! editor_load(${file});`);
							}
						} else {
							file["Dimension"] = null;
						}

						P_FILES[category].push(file);
					});

					await Promise.all(promises);
				} else {
					console.warn(`Категория [${category}] в файлах не найдена!`);
				}
			}
		}
		processFiles().then(() => {
			for (var category in P_FILES) {
				P_FILES[category].sort((a,b) => a["ID"] - b["ID"]);
			}
			log("Проект загружен!");
			loading.style.display = "none";
			page("e");
		})
		.catch(e => {
			loading.style.display = "none";
			error(e);
			fatal(`Произошла ошибка при загрузке файлов!`);
		});
	}catch(e){
		loading.style.display = "none";
		fatal(`Не получилось загрузить проект, ${e}`);
	}
}

const WindowWS = 1920;
const WindowHS =  916;
const WindowARS = WindowWS / WindowHS;

var WindowW = window.innerWidth;
var WindowH = window.innerHeight;
window.addEventListener("resize", function(e){
	var OldWindowW = WindowW;
	var OldWindowH = WindowH;
	WindowW = window.innerWidth;
	WindowH = window.innerHeight;

	var sx = WindowW / OldWindowW;
	var sy = WindowH / OldWindowH;

	var ar  = WindowW / WindowH;
	var ss = ar / WindowARS;

	if(CurrentPage === "e"){
		editor_moveworkspace(WorkspaceX * sx, WorkspaceY * sy);
	}
})

function calculate_background_position(){
	var wx = WorkspaceX - 2.5;
	wx /= WorkspaceS;
	var wy = WorkspaceY + 2.5;
	wy /= WorkspaceS;
	var ww = WindowW;
	var wh = WindowH;

	var x =  wx;
	   x +=  ww / 2;
	var xn = wx;
	   xn -= ww / 2;
	var y =  wy;
	   y +=  wh / 2;

	return [x, y, xn];
}

const pixelsize = 14 * 8;
function calculate_elements_scale(){
	var result = 1 / WorkspaceS;
	result *= pixelsize;
	result *= (WindowW / WindowH) / WindowARS;
	return result;
}

function editor_updateworkspace(){
	var pos = calculate_background_position();
	PAGE.style.backgroundPosition = `right ${pos[0]}px top ${pos[1]}px`;

	document.getElementById("WORKSPACE-CONTENT").style.transform = `translate(${-pos[2]}px, ${pos[1]}px) scale(${calculate_elements_scale()}%)`;

	document.getElementById("I-POS-X").value = WorkspaceX;
	document.getElementById("I-POS-Y").value = WorkspaceY;
	document.getElementById("I-SCALE").value = WorkspaceS;
}

var WorkspaceX = 0;
var WorkspaceY = 0;
/* Двигать рабочее пространство */
function editor_moveworkspace(newx = 0, newy = 0){
	WorkspaceX = newx;
	WorkspaceY = newy;
	
	editor_updateworkspace();
}

var WorkspaceS = 1;
/* Масштаб рабочего пространства */
function editor_scaleworkspace(news = 1){
	WorkspaceS = news;
	PAGE.style.backgroundSize = `${(1/WorkspaceS)*14*4}%`
	
	editor_updateworkspace();
}

/* Добавить элемент на рабочее пространство */
function editor_add_element(id = null,style = null,content = null,posX = null,posY = null){
	if(id      === null){id      = "WORKSPACE-ELEMENT"};
	if(style   === null){style   = ""};
	if(content === null){content = ""};
	if(posX    === null){posX    = 0 };
	if(posY    === null){posY    = 0 };

	document.getElementById("WORKSPACE-CONTENT").innerHTML += `<element id="${id}" style="position:absolute; ${style}">${content}</element>`;
}

function CLOSE_TOOLWINDOW(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.style.display = "none";
	TOOLWINDOW.innerHTML = "";
	SelectedCategory = -1;
}

function editor_stopeditfile(){
	document.getElementById("I-IN-EDIT").innerHTML = "<i>Ничего не редактируется...</i>";
	
	if(inedit){
		const element = document.getElementById("EL-IN-EDIT");
		element.remove();
	}
	
	inedit = null;
	
	document.getElementById("TOOL").innerHTML = `<i>Выберите файл, что-бы его редактировать</i>`;
}

var inedit = null;
function editor_editfile(i){
	if(editor_open_project_files_context_menu){
		editor_open_project_files_context_menu.remove();
	}
	var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
	
	if(inedit && file["Name"] === inedit["Name"] && file["Category"] === inedit["Category"]){
		fatal(`Уже редактируется этот файл [${file["Name"]}]!`);
	}else{	
		if(inedit){
			editor_stopeditfile();
		}
		
		inedit = file;
		log(`Редактируется файл [${file["Name"]}]!`);
		CLOSE_TOOLWINDOW();
		document.getElementById("I-IN-EDIT").innerHTML = `${file["Category"]}/${file["Name"]} [${file["Type"]}]`;
		
		if(!file["URL"]){
			file["URL"] = createurl(file);
		}
		
		var positionX = -50;
		var positionY = -50;
		var scaleX = 100 * 3.95;
		var scaleY = 100 * 3.95;
		editor_add_element("EL-IN-EDIT", null, `<div style="width: ${file["Dimension"][0]}px; height: ${file["Dimension"][1]}px; transform: translate(${positionX}%,${positionY}%) scale(${scaleX}%, ${scaleY}%);"><div id="EL-IN-EDIT-ZONES" style="position:absolute; width:100%; height:100%;"></div><img style="width:100%; height:100%; box-shadow: 0 0 0 1px black;" src="${file["URL"]}"></div>`,0,0);
	
		document.getElementById("TOOL").innerHTML = 
		`<b>${file["Name"]}</b><br>
		<button onclick="editor_stopeditfile();">Завершить редактирование</button><br>
		<div style="display: flex; justify-content: center;">Прозрачность [<text id="I-OPACITY">1.00</text>]:<input id="INPUT-OPACITY" type="range" min="0" max="1" step="0.01" value="1"></div>
		<div>Зоны<br>
			<div style="background-color:rgba(0,0,0,0.25); width:90%; height:200px; overflow-y:scroll;" id="ZONES" ></div>
			<button id="BUTTON-ADD-ZONE">Добавить зону</button>
			<button id="BUTTON-DELETE-ALL-ZONE">Удалить все зоны</button>
		</div>`;
		
		var el = document.getElementById("EL-IN-EDIT");
		
		function refresh_zones(){
			var el_zones_2 = document.getElementById("EL-IN-EDIT-ZONES");
			el_zones_2.innerHTML = "";
		
			var el_zones = document.getElementById("ZONES");
			el_zones.innerHTML = "";
			var zones = inedit["Zones"];
			
			for(var i_ = 0; i_ < zones.length; i_++){
				(function(i){
					var zone = zones[i];
					var z = document.createElement("div");
					z.style.width = "100%";
					z.style.backgroundColor = `rgba(255,255,255,${i % 2 == 0 ? 0.3 : 0.5})`;
					z.style.display = "flex";
					
					var integer = !zone[1];
					
					function getcolor(){
						var letters = "0123456789ABCDEF";
						var color = "#";
						for (var i = 0; i < 6; i++) {
							color += letters[Math.floor(Math.random() * 16)];
						}
						return color;
					}
					
					function getTextColor(hex) {
						hex = hex.replace("#", "");

						var r = parseInt(hex.substring(0, 2), 16);
						var g = parseInt(hex.substring(2, 4), 16);
						var b = parseInt(hex.substring(4, 6), 16);

						var brightness = (r * 299 + g * 587 + b * 114) / 1000;
						return brightness > 128 ? "#000000" : "#FFFFFF";
					}
					
					var zone_color = getcolor();
					var zone_color_text = getTextColor(zone_color);
					var zone_color_background = zone_color + "40";
					
					z.innerHTML = 
					`<input id="I-ZONEEDIT-${i}-NAME" type="text" style="background-color:${zone_color}; color:${zone_color_text}; flex: 1 1 auto; min-width: 0;">
					<input  id="I-ZONEEDIT-${i}-PROC" type="checkbox" style="flex: 1 0 auto; min-width: 0;">
					<input  id="I-ZONEEDIT-${i}-L" type="number" step="${integer ? 1 : 0.01}" style="flex: 1 2 auto; min-width: 0;">
					<input  id="I-ZONEEDIT-${i}-T" type="number" step="${integer ? 1 : 0.01}" style="flex: 1 2 auto; min-width: 0;">
					<input  id="I-ZONEEDIT-${i}-R" type="number" step="${integer ? 1 : 0.01}" style="flex: 1 2 auto; min-width: 0;">
					<input  id="I-ZONEEDIT-${i}-B" type="number" step="${integer ? 1 : 0.01}" style="flex: 1 2 auto; min-width: 0;">
					<button id="I-ZONEEDIT-${i}-DEL">🗑️</button style="flex: 1 2 auto; min-width: 0;">`;
					
					el_zones.appendChild(z);
					
					document.getElementById(`I-ZONEEDIT-${i}-NAME`).value = zone[0];
					document.getElementById(`I-ZONEEDIT-${i}-PROC`).checked = zone[1];
					document.getElementById(`I-ZONEEDIT-${i}-L`   ).value = zone[2];
					document.getElementById(`I-ZONEEDIT-${i}-T`   ).value = zone[3];
					document.getElementById(`I-ZONEEDIT-${i}-R`   ).value = zone[4];
					document.getElementById(`I-ZONEEDIT-${i}-B`   ).value = zone[5];
					
					document.getElementById(`I-ZONEEDIT-${i}-NAME`).addEventListener("input", function(){
						var regex = /[^a-zA-Z0-9-_.\s]/g;
						var v = this.value;
						
						if(regex.test(v)){
							v = v.replace(regex, "");
						}
						
						this.value = v;
						
						inedit["Zones"][i][0] = v;
					});
					document.getElementById(`I-ZONEEDIT-${i}-NAME`).addEventListener("blur", function(){
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-PROC`).addEventListener("change", function(){
						inedit["Zones"][i][1] = this.checked;
						var l = 0;
						var t = 0;
						var r = 1;
						var b = 1;
						if(!this.checked){
							r = inedit["Dimension"][0];
							b = inedit["Dimension"][1];
						}
						
						inedit["Zones"][i][2] = l;
						inedit["Zones"][i][3] = t;
						inedit["Zones"][i][4] = r;
						inedit["Zones"][i][5] = b;
						
						document.getElementById(`I-ZONEEDIT-${i}-L`).value = l;
						document.getElementById(`I-ZONEEDIT-${i}-T`).value = t;
						document.getElementById(`I-ZONEEDIT-${i}-R`).value = r;
						document.getElementById(`I-ZONEEDIT-${i}-B`).value = b;
						
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-L`).addEventListener("input", function(){
						var v = parseFloat(this.value);
						var max = inedit["Zones"][i][4] - (integer ? 1 : 0.01);
						
						if(isNaN(v) || v < 0){
							v = 0;
						}else if(v > max){
							v = max;
						}
						
						if(integer){
							v = Math.floor(v);
						}
						
						this.value = v;
						inedit["Zones"][i][2] = v;
					});
					document.getElementById(`I-ZONEEDIT-${i}-L`).addEventListener("blur", function(){
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-L`).addEventListener("mouseup", function(){
						if(document.activeElement !== this){
							refresh_zones();
						}
					});
					document.getElementById(`I-ZONEEDIT-${i}-T`).addEventListener("input", function(){
						var v = parseFloat(this.value);
						var max = inedit["Zones"][i][5] - (integer ? 1 : 0.01);
						
						if(isNaN(v) || v < 0){
							v = 0;
						}else if(v > max){
							v = max;
						}
						
						if(integer){
							v = Math.floor(v);
						}
						
						this.value = v;
						inedit["Zones"][i][3] = v;
					});
					document.getElementById(`I-ZONEEDIT-${i}-T`).addEventListener("blur", function(){
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-T`).addEventListener("mouseup", function(){
						if(document.activeElement !== this){
							refresh_zones();
						}
					});
					document.getElementById(`I-ZONEEDIT-${i}-R`).addEventListener("input", function(){
						var v = parseFloat(this.value);
						var max = integer ? inedit["Dimension"][0] : 1;
						var min = inedit["Zones"][i][2] + (integer ? 1 : 0.01);
						
						if(isNaN(v) || v < min){
							v = min;
						}else if(v > max){
							v = max;
						}
						
						if(integer){
							v = Math.floor(v);
						}
						
						this.value = v;
						inedit["Zones"][i][4] = v;
					});
					document.getElementById(`I-ZONEEDIT-${i}-R`).addEventListener("blur", function(){
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-R`).addEventListener("mouseup", function(){
						if(document.activeElement !== this){
							refresh_zones();
						}
					});
					document.getElementById(`I-ZONEEDIT-${i}-B`).addEventListener("input", function(){
						var v = parseFloat(this.value);
						var max = integer ? inedit["Dimension"][0] : 1;
						var min = inedit["Zones"][i][3] + (integer ? 1 : 0.01);
						
						if(isNaN(v) || v < min){
							v = min;
						}else if(v > max){
							v = max;
						}
						
						if(integer){
							v = Math.floor(v);
						}
						
						this.value = v;
						inedit["Zones"][i][5] = v;
					});
					document.getElementById(`I-ZONEEDIT-${i}-B`).addEventListener("blur", function(){
						refresh_zones();
					});
					document.getElementById(`I-ZONEEDIT-${i}-B`).addEventListener("mouseup", function(){
						if(document.activeElement !== this){
							refresh_zones();
						}
					});
					document.getElementById(`I-ZONEEDIT-${i}-DEL`).addEventListener("click", function(){
						const conf = confirm(`Вы действительно хотите удалить зону [${inedit["Zones"][i][0]}]?`);
						
						if(conf){
							inedit["Zones"].splice(i, 1);
							refresh_zones();
						}
					});
					
					var lt = [zone[2],zone[3]];
					var rb = [zone[4],zone[5]];
					
					if(!integer){
						lt[0] *= 100;
						lt[1] *= 100;
						rb[0] *= 100;
						rb[1] *= 100;
					}
					
					var wh = [rb[0]-lt[0],rb[1]-lt[1]];
					
					var zone_name = inedit["Zones"][i][0];
					
					var fontsize = ((inedit["Dimension"][0]/9)/zone_name.length) * (wh[0]/(integer ? inedit["Dimension"][0] : 100));
					
					el_zones_2.innerHTML += 
					`<div style="position:absolute; display:flex; justify-content:center; align-items:center; font-size:${fontsize}em; background-color:${zone_color_background}; box-shadow: inset 0 0 0 0.2px ${zone_color}; text-shadow: 0.2px 0 0px ${zone_color_text}, 0px 0.2px 0px ${zone_color_text}, -0.2px 0 0px ${zone_color_text}, 0px -0.2px 0px ${zone_color_text}; color:${zone_color}; left:${lt[0]}${integer ? "px" : "%"}; top:${lt[1]}${integer ? "px" : "%"}; width:${wh[0]}${integer ? "px" : "%"}; height:${wh[1]}${integer ? "px" : "%"};">${zone_name}</div>`;
				})(i_);
			}
		}
		
		document.getElementById("BUTTON-ADD-ZONE").addEventListener("click", function(){
			inedit["Zones"].push([`${inedit["ClearName"]}_${inedit["Zones"].length}`, true, 0, 0, 1, 1]);
			refresh_zones();
		});
		document.getElementById("BUTTON-DELETE-ALL-ZONE").addEventListener("click", function(){
			const conf = confirm(`Вы действительно хотите все удалить зоны?`);
			
			if(conf){
				inedit["Zones"] = [];
				refresh_zones();
			}
		});
		
		var opacity_slider = document.getElementById("INPUT-OPACITY");
		opacity_slider.addEventListener("input", function(){
			var v = parseFloat(this.value);
			document.getElementById("I-OPACITY").innerText = v.toFixed(2);
			
			el.style.opacity = v;
		});
		
		refresh_zones();
	}
}

function editor_open_project_settings(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:40vw; height:30vh; margin-left:30vw; margin-top:35vh; padding:32px; box-sizing: border-box;">
	Название:~<input type="text" id="I-PROJECTNAME"    maxlength="50" placeholder="New MRC Project" value="${P_NAME}" style="width:80%;"><br>
	Автор:~~~~<input type="text" id="I-PROJECTAUTHOR"  maxlength="50" placeholder="Anonymous" value="${P_AUTHOR}" style="width:80%;"><br>
	Лицензия:~<input type="text" id="I-PROJECTLICENSE" maxlength="50" placeholder="Not specified" value="${P_LICENSE}" style="width:80%;"><br>
	
	<br>
	
	<center><button onclick="CLOSE_TOOLWINDOW();">Закрыть</button></center>
</div>`.replace(/~/g,"&nbsp;");
	
	document.getElementById("I-PROJECTNAME").addEventListener("input", function(e){
		const v = e.target.value.replace(/[^A-Za-z0-9 _]/g, '');
		e.target.value = v;
		P_NAME = v;
		editor_make_unsave();
	});
	document.getElementById("I-PROJECTAUTHOR").addEventListener("input", function(e){
		const v = e.target.value.replace(/["\\]/g, '');
		e.target.value = v;
		P_AUTHOR = v;
		editor_make_unsave();
	});
	document.getElementById("I-PROJECTLICENSE").addEventListener("input", function(e){
		const v = e.target.value.replace(/["\\]/g, '');
		e.target.value = v;
		P_LICENSE = v;
		editor_make_unsave();
	});
	
	TOOLWINDOW.style.display = "unset";
}

function editor_open_project_files_refresh(){
	if(editor_open_project_files_context_menu!=null){
		editor_open_project_files_context_menu.remove();
	}

	document.getElementById("I-FILE-TABLE").innerHTML = "";
	if(!P_FILES[P_CATEGORIES[SelectedCategory]]){ P_FILES[P_CATEGORIES[SelectedCategory]] = []; }
	var total = 0;
	var total_there = 0;
	for(var category in P_FILES){
		var files = P_FILES[category];
		total += files.length;
		if(category === P_CATEGORIES[SelectedCategory]){
			total_there = files.length;
			for(var i = 0; i < files.length; i++){
				editor_open_project_files_addfile(files[i],category,i);
			}
		}
	}
	
	document.getElementById("I-FILES-TOTAL"      ).innerText = total;
	document.getElementById("I-FILES-TOTAL-THERE").innerText = total_there;
	
	var select = "";
	for(category of P_CATEGORIES){
		select += `<option value="${category}"${P_CATEGORIES[SelectedCategory]===category?" selected":""}>${category}</option>`;
	}
	document.getElementById("I-SELECT-CATEGORY").innerHTML = select;
}
function editor_open_project_files_remove_all(){
	const conf = confirm(`Вы действительно хотите всё удалить в категории [${P_CATEGORIES[SelectedCategory]}]?`);

	if(conf){
		for(var i = 0; i < P_FILES[P_CATEGORIES[SelectedCategory]].length; i++){
			var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
			if(file["URL"]){ URL.revokeObjectURL(file["URL"]); }
		}
		delete P_FILES[P_CATEGORIES[SelectedCategory]];

		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_remove_base(i){
	var files = P_FILES[P_CATEGORIES[SelectedCategory]];
	files.splice(i, 1);

	for (let j = i; j < files.length; j++) {
		files[j]["ID"] -= 1;
	}
}
function editor_open_project_files_remove(i){
	const conf = confirm(`Вы действительно хотите удалить [${P_FILES[P_CATEGORIES[SelectedCategory]][i]["Name"]}]?`);

	if(conf){
		var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
		if(file["URL"]){ URL.revokeObjectURL(file["URL"]); }
	
		editor_open_project_files_remove_base(i);

		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_movefile(i,arrow){
	var newi = 0;
	switch(arrow){
		case 1 /* ← */: newi = i - 1 ; break;
		case 2 /* ↓ */: newi = i + 12; break; 
		case 3 /* ↑ */: newi = i - 12; break;
		case 4 /* → */: newi = i + 1 ; break;
		default: break;
	}
	
	var files = P_FILES[P_CATEGORIES[SelectedCategory]];
	if(newi >= 0 && newi < files.length){
		var old = files[newi];
		files[newi] = files[i];
		files[i] = old;
		
		files[newi]["ID"] = newi;
		files[i]["ID"] = i;
		
		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_replace(i,andname){
	var input = document.getElementById("FILE_REPLACE");
	
	//Очистка от ивентов
	const newinput = input.cloneNode(true);
	input.parentNode.replaceChild(newinput, input);
	input = newinput;
	
	var files = P_FILES[P_CATEGORIES[SelectedCategory]];
	var file = files[i];
	
	function replacefile(newfile){
		var name = andname ? newfile.name.replace(/[^\x00-\x7F]/g, "-") : file["Name"];
		
		const hasduplicates = andname ? files.some(item => item.Name === name) : false;
		
		if(hasduplicates){
			fatal(`Файл с таким именем [${name}] уже есть!`);
		}else{
			const reader = new FileReader();
			var ThatByteArray = file["ContentType"];
			reader.onload = function(e){
				file["Name"] = name;
				var content = e.target.result;
				file["Size"] = (ThatByteArray ? content.byteLength : content.length);
				if(file["URL"]){ URL.revokeObjectURL(file["URL"]); }
				file["URL"] = null;
				file["Content"] = content;
				if(file["Type"]==="texture"){
					get_png_dimension(content).then(dimension => {
						file["Dimension"] = dimension;
					
						editor_open_project_files_refresh();
						editor_make_unsave();
					}).catch(e => {
						fatal(`Не получилось определить размер изображения [${file["Name"]}]! addfile(${id},${file});`);
					})
				}else{
					file["Dimension"] = null;
				
					editor_open_project_files_refresh();
					editor_make_unsave();
				}
			};
			if(ThatByteArray){
				reader.readAsArrayBuffer(newfile);
			}else{
				reader.readAsText(newfile, "UTF-8");
			}
		}
	}
	
	if(file["Type"]==="texture"){
		input.accept = ".png";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")){
					log(`Заменено изображение [${file.name}]!`);
					replacefile(ProjectFile);
				}else{
					fatal(`Выбранный файл, не является с форматом ".png"!`);
				}
			}
		});
	}else if(file["Type"]==="sound"){
		input.accept = ".ogg";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".ogg")){
					log(`Заменён звук [${Pfile.name}]!`);
					replacefile(ProjectFile);
				}else{
					fatal(`Выбранный файл, не является с форматом ".ogg"!`);
				}
			}
		});
	}else{
		input.accept = "";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")||ProjectFile.name.endsWith(".ogg")){
					fatal(`Выбранный файл, с форматом ".png" или ".ogg"! (выберите другие кнопки)`);
				}else{
					log(`Заменён файл [${file.name}]!`);
					replacefile(ProjectFile);
				}
			}
		});
	}
	input.click();
}
function createurl(file){
	var t = "text/plain;charset=utf-8"
	
	if(file["Type"]==="texture"){
		t = "image/png";
	}else if(file["Type"]==="texture"){
		//t = ""
	}

	var blob = new Blob([file["Content"]], { type: t });
	return URL.createObjectURL(blob);
}
function editor_open_project_files_download_file(i){
	var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
	if(!file["URL"]){
		file["URL"] = createurl(file);
	}
	
	const a = document.createElement("a");
	a.href = file["URL"];
	a.download = file["Name"];
	document.body.appendChild(a);
	a.click();
	document.body.removeChild(a);
	
	if(editor_open_project_files_context_menu!=null){
		editor_open_project_files_context_menu.remove();
	}
}
var editor_open_project_files_context_menu = null;
function editor_open_project_files_addfile(f,category,i){
	var files_table = document.getElementById("I-FILE-TABLE");
	
	var element = document.createElement("file");
	
	element.style.backgroundColor = "rgba(255,255,255,0.9)";
	element.style.width    = "125px";
	element.style.height   = "140px";
	element.style.overflow = "hidden";
	
	var icon = "";
	
	if(f["Type"] === "texture"){
		var url = f["URL"];
		if(!url){
			f["URL"] = createurl(f);
		}
	
		icon = `<center style="width:100%; height:100%;"><img style="height:100%; width:100%;" src="${f["URL"]}"></center>`;
	}else{
		icon = `<center style="width:100%; height:100%; position: relative; overflow:hidden;"><img style="height:100%; width:100%;" src="ge/file.png"><div style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%);">${f["Name"]}</div></center>`;
	}
	
	var title = `${category}/${f["Name"]}`;
	if(f["Type"]==="texture"){
		title += ` [${f["Dimension"][0]}x${f["Dimension"][1]}]`;
	}
	
	element.innerHTML = 
	`<div style="${f["Type"]==="texture"?"background-image:url('source/transparent.png');":""} width:100%; height:85%; cursor:help;" title="${title}">${icon}</div>
	<button onclick="editor_open_project_files_movefile(${i},1);">←</button><button onclick="editor_open_project_files_movefile(${i},2);">↓</button><button onclick="editor_open_project_files_movefile(${i},3);">↑</button><button onclick="editor_open_project_files_movefile(${i},4);">→</button><button style="font-size:0.5em;" title="Редактировать" onclick="editor_editfile(${i});">✏️</button><button style="font-size:0.5em;" title="Удалить" onclick="editor_open_project_files_remove(${i});">🗑️</button>`;
	
	element.addEventListener("contextmenu", function(e){ 
		if(!e.shiftKey){
			e.preventDefault(); 
			if(editor_open_project_files_context_menu!=null){
				editor_open_project_files_context_menu.remove();
			}
			
			editor_open_project_files_context_menu                       = document.createElement("contextmenu");
			editor_open_project_files_context_menu.style.backgroundColor = "rgb(250,250,250)";
			editor_open_project_files_context_menu.style.width           = "300px";
			editor_open_project_files_context_menu.style.height          = "500px";
			editor_open_project_files_context_menu.style.display         = "flex";
			editor_open_project_files_context_menu.style.flexDirection   = "column";
			editor_open_project_files_context_menu.style.position        = "fixed";
			editor_open_project_files_context_menu.style.left            = `${e.pageX}px`;
			editor_open_project_files_context_menu.style.top             = `${e.pageY}px`;
			editor_open_project_files_context_menu.style.zIndex          = "3000";
			
			var select = "";
			for(category of P_CATEGORIES){
				select += `<option value="${category}"${P_CATEGORIES[SelectedCategory]===category?" selected":""}>${category}</option>`;
			}
			
			editor_open_project_files_context_menu.innerHTML = 
			`<center>${f["Name"]}</center>
			<button onclick="editor_editfile(${i});">Редактировать</button>
			<div style="display:flex;"><button style="flex:1;" title="Заменяет только содержимое файла" onclick="editor_open_project_files_replace(${i},false);">Заменить содержимое</button><button style="flex:1;" title="Заменяет содержимое и название файла" onclick="editor_open_project_files_replace(${i},true);">Заменить<br>весь файл</button></div>
			<select id="I-CONTEXT-SELECTCATEGORY">${select}</select>
			<button onclick="editor_open_project_files_download_file(${i});">Скачать</button>
			<button onclick="editor_open_project_files_remove(${i});">Удалить</button>
			<button onclick="log(P_FILES[P_CATEGORIES[SelectedCategory]][${i}]);">DEBUG INFO</button>
			`;
			
			BODY.appendChild(editor_open_project_files_context_menu);
			
			document.getElementById("I-CONTEXT-SELECTCATEGORY").addEventListener("change", function() {
				var selected = this.value;
				if(selected !== P_CATEGORIES[SelectedCategory]){
					if(!P_FILES[selected]){ P_FILES[selected] = []; }
					const hasduplicates = P_FILES[selected].some(item => item.Name === f["Name"]);
		
					if(hasduplicates){
						fatal(`Файл с таким именем [${f["Name"]}] уже есть в указанной категории!`);
						this.value = P_CATEGORIES[SelectedCategory];
					}else{
						editor_open_project_files_remove_base(f["ID"]);
						f["ID"      ] = P_FILES[selected].length;
						f["Category"] = selected;
						P_FILES[selected].push(f);
						
						editor_open_project_files_refresh();
						editor_make_unsave();
					}
				}
			});
		}
	});
	
	files_table.appendChild(element);
}
function editor_open_project_files_open(t){
	var input = document.getElementById("FILE_INPUT");
	
	//Очистка от ивентов
	const newinput = input.cloneNode(true);
	input.parentNode.replaceChild(newinput, input);
	input = newinput;
	
	function addfile(id,file,i = null){
		if(!P_FILES[P_CATEGORIES[SelectedCategory]]){ P_FILES[P_CATEGORIES[SelectedCategory]] = []; }
		
		var files = P_FILES[P_CATEGORIES[SelectedCategory]];
		var name = file.name.replace(/[^\x00-\x7F]/g, "-");
		
		var lastdot = name.lastIndexOf(".");
		var clearname, name_extension;
		if (lastdot !== -1) {
			clearname      = name.substring(0, lastdot);
			name_extension = name.substring(   lastdot);
		} else {
			clearname      = name;
			name_extension = "";
		}
		
		if(i){
			name = name_base + (i+1) + name_extension;
		}
		
		const hasduplicates = files.some(item => item.Name === name);
		
		if(hasduplicates){
			fatal(`Файл с таким именем [${name}] уже есть!`);
		}else{
			const reader = new FileReader();
			var ThatByteArray = false;
			reader.onload = function(e){
				var content = e.target.result;
				var result = {
					"Name"       : name,
					"ClearName"  : clearname,
					"Type"       : id,
					"Size"       : (ThatByteArray ? content.byteLength : content.length),
					"ContentType": (ThatByteArray ? "byte" : "text"),
					"URL"        : null,
					"Category"   : P_CATEGORIES[SelectedCategory],
					"ID"         : P_FILES[P_CATEGORIES[SelectedCategory]].length,
					"Zones"      : [[clearname, true, 0, 0, 1, 1]],
					"Content"    : content
				};
				if(id === "texture"){
					get_png_dimension(content).then(dimension => {
						result["Dimension"] = dimension;
						P_FILES[P_CATEGORIES[SelectedCategory]].push(result);
					
						editor_open_project_files_refresh();
						editor_make_unsave();
					}).catch(e => {
						fatal(`Не получилось определить размер изображения [${file["Name"]}]! addfile(${id},${file});`);
					})
				}else{
					result["Dimension"] = null;
					P_FILES[P_CATEGORIES[SelectedCategory]].push(result);
				
					editor_open_project_files_refresh();
					editor_make_unsave();
				}
			};
			if(id=="texture"||id=="sound"){
				ThatByteArray = true;
				reader.readAsArrayBuffer(file);
			}else{
				reader.readAsText(file, "UTF-8");
			}
		}
	}
	
	var debug_morefiles = document.getElementById("I-DEBUG-MOREFILES").checked;
	if(t === "i"){
		input.accept = ".png";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")){
					log(`Добавлено изображение [${ProjectFile.name}]${debug_morefiles?" 12 раз":""}!`);
					if(debug_morefiles){
						for(var i = 0; i < 12; i++){
							addfile("texture",ProjectFile,i);
						}
					}else{
						addfile("texture",ProjectFile);
					}
				}else{
					fatal(`Выбранный файл, не является с форматом ".png"!`);
				}
			}
		});
	}else if(t === "s"){
		input.accept = ".ogg";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".ogg")){
					log(`Добавлен звук [${ProjectFile.name}]${debug_morefiles?" 12 раз":""}!`);
					if(debug_morefiles){
						for(var i = 0; i < 12; i++){
							addfile("sound",ProjectFile,i);
						}
					}else{
						addfile("sound",ProjectFile);
					}
				}else{
					fatal(`Выбранный файл, не является с форматом ".ogg"!`);
				}
			}
		});
	}else{
		input.accept = "";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")||ProjectFile.name.endsWith(".ogg")){
					fatal(`Выбранный файл, с форматом ".png" или ".ogg"! (выберите другие кнопки)`);
				}else{
					log(`Добавлен файл [${ProjectFile.name}]${debug_morefiles?" 12 раз":""}!`);
					if(debug_morefiles){
						for(var i = 0; i < 12; i++){
							addfile("other",ProjectFile,i);
						}
					}else{
						addfile("other",ProjectFile);
					}
				}
			}
		});
	}
	input.click();
}
var SelectedCategory = -1;
function editor_open_project_files_category_open(i){
	if(SelectedCategory!==i){
		if(SelectedCategory!=-1){
			document.getElementById(`I-CATEGORY-${SelectedCategory}`).disabled = false;
		}
		SelectedCategory = i;
		
		document.getElementById(`I-CATEGORY-${i}`).disabled = true;
		
		editor_open_project_files_refresh();
	}
}
function editor_open_project_files(){
	editor_stopeditfile();

	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:90vw; height:90vh; margin-left:5vw; margin-top:5vh; padding:32px; box-sizing: border-box;">
	Добавить: <button onclick="editor_open_project_files_open('i');">Изображение (.png)</button><button onclick="editor_open_project_files_open('s');">Звук (.ogg)</button><button onclick="editor_open_project_files_open();">Остальное</button>
	<br>
	<text style="color:red;">Внимание! Не загружайте файлы с символами в названии выходящими за пределы ASCII (к примеру с киррилицей нельзя)</text>
	<br><br>
	<div style="width:95%; margin-left:2.5%; height:85%; background-color:rgba(0,0,0,0.25); display:flex; flex-direction:column;">
		<div style="width:100%; background-color:rgba(255,255,255,0.5);" id="I-CATEGORIES"></div>
		<div style="width:100%; flex:1; overflow-y:scroll; display: grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: 1fr; grid-gap: 5px; padding:5px;" id="I-FILE-TABLE"></div>
		<div style="width:100%; height: 1.25em; background-color:rgba(255,255,255,0.5);">
			Файлов всего: <text id="I-FILES-TOTAL">?</text> | 
			Файлов тут: <text id="I-FILES-TOTAL-THERE">?</text> | 
			<select id="I-SELECT-CATEGORY"></select> | <button onclick="editor_open_project_files_remove_all();">Всё тут удалить</button> | 
			<button onclick="log(P_CATEGORIES);log(P_FILES);">DEBUG INFO</button>
			<input type="checkbox" title="Добавляет сразу 12 файлов, а не 1" id="I-DEBUG-MOREFILES">
		</div>
	</div>
	<br>
	<center><button onclick="CLOSE_TOOLWINDOW(); SelectedCategory=-1;">Закрыть</button></center>
</div>`;
	
	var result_categ = `<button onclick="editor_open_project_categories(); SelectedCategory = -1;" title="Редактировать категории">✏️</button> `;
	for(var i = 0; i < P_CATEGORIES.length; i++){
		var category = P_CATEGORIES[i];
		result_categ += `<button onclick="editor_open_project_files_category_open(${i});" id="I-CATEGORY-${i}">${i+1} : ${category}</button>`;
	}
	document.getElementById("I-CATEGORIES").innerHTML = result_categ;
	
	editor_open_project_files_category_open(0);
	
	document.getElementById("I-SELECT-CATEGORY").addEventListener("change", function(){
		var selected = this.value;
		if(selected !== P_CATEGORIES[SelectedCategory]){
			const conf = confirm(`Вы действительно хотите всё переместить из категории [${P_CATEGORIES[SelectedCategory]}] в [${selected}]?`);
			
			if(conf){
				var files  = P_FILES[P_CATEGORIES[SelectedCategory]];
				if(!P_FILES[selected]){ P_FILES[selected] = []; }
				var files2 = P_FILES[selected];
				
				var hasduplicates = false;
				
				for(var i = 0; i < files.length; i++){
					var f = files[i];
					if(files2.some(item => item.Name === f["Name"])){
						hasduplicates = true;
						break;
					}
				}
			
				if(hasduplicates){
					fatal(`Файл с таким именем [${f["Name"]}] уже есть в указанной категории!`);
				}else{
					for(var i = 0; i < files.length; i++){
						var f = files[i];
						f["ID"      ] = files2.length;
						f["Category"] = selected;
						files2.push(f);
					}
					
					for(var i = 0; i < files.length; i++){
						var f = files[i];
						if(f["URL"]){ URL.revokeObjectURL(f["URL"]); }
					}
					delete P_FILES[P_CATEGORIES[SelectedCategory]];
					
					editor_open_project_files_refresh();
					editor_make_unsave();
				}
				this.value = P_CATEGORIES[SelectedCategory];
			}
		}
	});
	
	TOOLWINDOW.style.display = "unset";
}

function editor_open_project_categories_delete(i){
	var files = P_FILES[P_CATEGORIES[i]];
	if(!files || files.length === 0){
		var category = P_CATEGORIES[i];
		if(P_FILES[category]){ delete P_FILES[category]; }
		P_CATEGORIES.splice(i, 1);
		editor_open_project_categories_refresh();
		editor_make_unsave();
	}else{
		fatal("Нельзя удалить категорию, потому-что в ней есть файлы!");
	}
}
function editor_open_project_categories_refresh(){
	var ic = document.getElementById("I-CATEGORIES");
	
	function addcategory_topanel(i){
		var category = P_CATEGORIES[i];
		
		var result = document.createElement("div");
		result.style.width = "100%";
		result.style.backgroundColor = `rgba(255,255,255,${i%2===0?0.5:0.3})`;
		
        result.appendChild(document.createTextNode(`${(i+1)<10?"0":""}${i+1} `));

        var downButton = document.createElement("button");
        downButton.textContent = "↓";
		var downresult = i+2;
		if(i==P_CATEGORIES.length-1){ downresult = 1; }
		downButton.title = `Переместить на ${downresult < 10 ? "0" : ""}${downresult}`;
        downButton.onclick = function() {
            editor_open_project_categories_move(category, false);
        };
        result.appendChild(downButton);
		
		var upButton = document.createElement("button");
        upButton.textContent = "↑";
		var upresult = i;
		if(i==0){ upresult = P_CATEGORIES.length; }
		upButton.title = `Переместить на ${upresult < 10 ? "0" : ""}${upresult}`;
        upButton.onclick = function() {
            editor_open_project_categories_move(category, true);
        };
        result.appendChild(upButton);
		
		result.appendChild(document.createTextNode(" "));

        var input = document.createElement("input");
        input.type = "text";
        input.value = category;
        input.style.width = "60%";
		input.maxLength = "30";
        input.id = `I-INPUT-${i}`;
		input.addEventListener("input", function(e){
			const v = e.target.value.replace(/[^A-Za-z0-9 _А-Яа-яЁё]/g, '');
			e.target.value = v;
			var oldcategory = P_CATEGORIES[i];
			P_CATEGORIES[i] = v;
			var files = P_FILES[oldcategory];
			if(files){
				for(var j = 0; j < files.length; j++){
					files[j]["Category"] = v;
				}
				delete P_FILES[oldcategory];
				P_FILES[v] = files;
			}
			editor_make_unsave();
		});
		input.addEventListener("blur", function(e){
			editor_open_project_categories_refresh();
		});
		result.appendChild(input);
		
		result.appendChild(document.createTextNode(" "));
		
		var deleteButton = document.createElement("button");
		deleteButton.textContent = "🗑️";
		deleteButton.onclick = function(){
			editor_open_project_categories_delete(i);
		}
		result.appendChild(deleteButton);
		
		ic.appendChild(result);
	}
	
	ic.innerHTML = "";
	for(var i = 0; i < P_CATEGORIES.length; i++){
		addcategory_topanel(i);
	}
	
	document.getElementById("I-CATEGORIES-COUNT").innerText = P_CATEGORIES.length;
}
function editor_open_project_categories_move(category,up){
	const i = P_CATEGORIES.indexOf(category);
	
	if(up){
		if(i===0){
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.push(category);
		}else{
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.splice(i - 1, 0, category);
		}
	}else{
		if(i===P_CATEGORIES.length - 1){
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.unshift(category);
		}else{
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.splice(i + 1, 0, category);
		}
	}

	editor_open_project_categories_refresh();
	editor_make_unsave();
}
function editor_open_project_categories_create(){
	if(P_CATEGORIES.length < 30){
		P_CATEGORIES.push(`Новая категория (${P_CATEGORIES.length+1})`);
		editor_open_project_categories_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_categories_back(){
	if(P_CATEGORIES.length > 0){
		var hasduplicates = false;
	
		var seen = {};
		for(var i = 0; i < P_CATEGORIES.length; i++){
			var category = P_CATEGORIES[i];
			if(seen[category]){ hasduplicates = true; }
			seen[category] = true;
		}
	
		if(!hasduplicates){
			editor_open_project_files();
		}else{
			fatal("Есть повторяющиеся категории!");
		}
	}else{
		fatal("Нужно имееть хотя-бы одну категорию!");
	}
}
function editor_open_project_categories(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:20vw; height:80vh; margin-left:40vw; margin-top:5vh; padding:16px; box-sizing: border-box;">
	<div style="width:95%; margin-left:2.5%; height:82.5%; background-color:rgba(0,0,0,0.25); overflow-y:scroll;" id="I-CATEGORIES"></div>
	<br>
	<center><text>Категорий: <text id="I-CATEGORIES-COUNT">?</text></text></center>
	<br>
	<center><button onclick="editor_open_project_categories_create();">Добавить</button></center>
	<br>
	<center><button onclick="editor_open_project_categories_back();">Закрыть</button></center>
</div>`;
	
	editor_open_project_categories_refresh();
	
	TOOLWINDOW.style.display = "unset";
}

function INSTALL_PAGE_EDITOR(){
	var WORKSPACE = document.getElementById("WORKSPACE");
	var PAGE = document.getElementById("PAGE");

	var MouseDown = false;
	var ClickX = 0, ClickY = 0;
	PAGE.addEventListener("contextmenu", function(e){ if(!e.shiftKey){ e.preventDefault(); } });
	WORKSPACE.addEventListener("mousedown", function(e){
		if(e.button === 2 && !MouseDown){ MouseDown = true; ClickX = e.clientX; ClickY = e.clientY;
			BODY.style.cursor = "grabbing";
			WORKSPACE.style.cursor = "grabbing";
		}
	});
	PAGE.addEventListener("mouseup", function(e){
		if(e.button === 2){ MouseDown = false;
			BODY.style.cursor = "default";
			WORKSPACE.style.cursor = "grab";
		}
	});
	PAGE.addEventListener("mousemove", function(e){
		if(MouseDown){
			const dx = e.clientX - ClickX;
			const dy = e.clientY - ClickY;

			WorkspaceX -= dx * WorkspaceS;
			WorkspaceY += dy * WorkspaceS;

			ClickX = e.clientX;
			ClickY = e.clientY;

			editor_moveworkspace(WorkspaceX, WorkspaceY);
		}
	});
	WORKSPACE.addEventListener("wheel", function(e){
		e.preventDefault();

		WorkspaceS *= e.deltaY > 0 ? 1.1 : 0.9;
		editor_scaleworkspace(WorkspaceS);
	});

	editor_moveworkspace(); editor_scaleworkspace();

	document.getElementById("I-POS-X").addEventListener("input", function(e){
		var v = parseInt(e.target.value,10);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			e.target.value = v;
			editor_moveworkspace(v, WorkspaceY);
		}
	});
	document.getElementById("I-POS-Y").addEventListener("input", function(e){
		var v = parseInt(e.target.value,10);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			e.target.value = v;
			editor_moveworkspace(WorkspaceX, v);
		}
	});
	document.getElementById("I-SCALE").addEventListener("input", function(e){
		var v = parseFloat(e.target.value);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			v = Math.abs(v);
			if(v===0){v=1;}
			e.target.value = v;
			editor_scaleworkspace(v);
		}
	});

	editor_add_element("EL-CENTER",null,`<img style="width: 64px; height: 64px; transform: translate(-46.25%,-46.25%);" src="source/center.png">`,0,0);
	
	editor_stopeditfile();
}

document.addEventListener("keydown", function(e){
	if(CurrentPage==="e"){
		if(e.key === "Home"){ editor_moveworkspace(); editor_scaleworkspace(); }
	}
});
document.addEventListener("mousedown", function(e){
	if(editor_open_project_files_context_menu){
		if(!editor_open_project_files_context_menu.contains(e.target)){
			editor_open_project_files_context_menu.remove();
		}
	}
});
window.addEventListener("beforeunload",function(e){
	if(CurrentPage==="e" && !SAVED){
		e.preventDefault();
		e.returnValue = "";
	}
});

function page(id){
	var result = "ERROR";
	var func = function(){};
	CurrentPage = id;
	if(id==="e"){
		result = PAGE_EDITOR;
		func = INSTALL_PAGE_EDITOR;
	}else{
		result = PAGE_STARTPAGE;
		CurrentPage = "";
	}
	BODY.innerHTML = result;
	func();
}

var MS_LastTime = performance.now();
var MS = -1;
var MS_Count = 0;
function RenderLoop(){
	MS_Count++;

	var Now = performance.now();
	MS = Now - MS_LastTime;
	MS_LastTime = Now;

	if(MS_Count>5){
		var ms_label = document.getElementById("I-MS");
		if(ms_label){ ms_label.innerText = `${MS} ms (норм:16-18)`; }
		MS_Count = 0;
	}

	requestAnimationFrame(RenderLoop);
}
requestAnimationFrame(RenderLoop);

//=============================
page();
</script>
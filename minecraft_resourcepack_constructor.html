<!DOCTYPE HTML>
<meta charset="utf-8">
<title>MRC</title>
<link rel="icon" type="image/x-icon" href="source/bloodraw/iconblock.ico">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

<style>
body{
	width:100%;
	height:100%;
	margin: 0;
}

body, input, button{
	font-family: Consolas, monospace;
}

img{
	image-rendering: pixelated;
}

*:not(input)::selection{
	background: currentBackgroundColor;
	color     : currentColor;
}

button:not(:disabled){
	cursor: pointer;
}

/* =================================== */

#WORKSPACE{
	display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    gap: 10px;
	width:50vw;
	height:100vh;
	cursor:grab;
	box-sizing: border-box;
	z-index:5;
	text-shadow: 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white, 0 0 5px white;
}

#WORKSPACE-INFO{
	display: inherit;
}
</style>

<body>
	<div style="width:100%; height:100%; display: flow-root;" id="BODY"></div>
	<input type="file" id="FILE_PROJECT_INPUT" accept=".mrc-proj" style="display: none;">
	<input type="file" id="FILE_INPUT" style="display: none;">
</body>

<script>
// –ü–ê–ö

// –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–∞
var P_NAME = "New MRC Project";
// –ê–≤—Ç–æ—Ä –ø–∞–∫–∞
var P_AUTHOR = "";
// –õ–∏—Ü–µ–Ω–∑–∏—è –ø–∞–∫–∞
var P_LICENSE = "";

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
var P_CATEGORIES = ["–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"];
// –§–∞–π–ª—ã
var P_FILES = {};

//===========================================
// –°–ê–ô–¢

const VERSION = "1";

var errorhas = false;
function detecterror(){
	if(!errorhas){
		errorhas = true;
		alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞! –°–ú. –∫–æ–Ω—Å–æ–ª—å - F12");
	}
}
window.addEventListener("error", (e) => {
	detecterror();
});

function stackline(){ const err = new Error(); var line = err.stack.split('\n')[2]; const match = line.match(/\d+:\d+/g); if(match){ return `${match[0]}`; } return line; }
function log  (message){ var m = message;  message = `${message} <${stackline()}>`; console.log  (typeof m === "object" ? m : message);                }
function warn (message){ message = `${message} <${stackline()}>`; console.warn ("%c%s", "color: yellow; font-weight: bold;" , message);                }
function error(message){ message = `${message} <${stackline()}>`; console.error("%c%s", "color: red; font-weight: bold;"    , message); detecterror(); }
function fatal(message){ message = `${message} <${stackline()}>`; const style = "color: white; background-color: red; font-weight: bold; padding: 4px; border-radius: 4px;"; console.error("%c%s", style, message); alert("Fatal: " + message); }

const BODY = document.getElementById("BODY");

/* –ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω? */
var SAVED = true;

const FileExtension_Project  = ".mrc-proj";
const FileExtension_Compiled = ".mrc"     ;
var CurrentPage = "";

const PAGE_STARTPAGE =
`<panel style="position:fixed; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:1000; display:flex; justify-content: center; align-items: center; color:white; font-size:2em; display:none;" id="LOADING">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–æ–µ–∫—Ç...</panel>
<center id="STARTPAGE" style="width:100vw; height:100vh;">
	<br>
	<text style="font-size:3em;">MRC ${VERSION}</text>
	<br><br>
	<button onclick="editor_create();" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π –ø—Ä–æ–µ–∫—Ç">–°–æ–∑–¥–∞—Ç—å</button>
	<br>
<button onclick="editor_open();" title="–¢–∞–∫ –∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º">–û—Ç–∫—Ä—ã—Ç—å</button>
</center>`;

const PAGE_EDITOR =
`<panel style="position:fixed; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content: center; align-items: center; color:white; font-size:2em; display:none;" id="LOADING">?</panel>
<panel style="position:fixed; width:100vw; height:100vh; background-color:rgba(0,0,0,0.5); z-index:1000; display:none;" id="TOOL-WINDOW"></panel>
<div style="display: flex; background-color:lightgray; background-image:url('source/grid2.png'); image-rendering: pixelated; transition: all 0.1s ease;" id="PAGE">
	<panel style="position:fixed; width: 5px; height: 5px; pointer-events: none;" id="WORKSPACE-CONTENT"></panel>
	<panel style="display:block; width:25vw; height:100vh; background-color:white; border-right:3px solid black; z-index:5;">
		<center style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
			<button style="margin-top:20px;" onclick="editor_open_project_settings();">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</button>
			<br>
			<button onclick="editor_open_project_files();">–§–∞–π–ª—ã</button>
			<br>
			<button style="position: fixed; bottom: 40px;" onclick="editor_save();" id="SAVE" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
			<button style="position: fixed; bottom: 20px;" onclick="fatal('–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!!!');">–°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å</button>
		</center>
	</panel>
	<panel id="WORKSPACE">
		<!-- R/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: flex-start;">
			<text id="I-MS">?</text>
		</panel>

		<!-- C/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: center;    ">
			<text style="color:lime;">+Y</text>
		</panel>

		<!-- L/T --> <panel id="WORKSPACE-INFO" style="align-items: flex-start; justify-content: flex-end;  ">
			<text>X: <input id="I-POS-X" type="number" step="1" pattern="\d*" value="0"></text>
			<text>Y: <input id="I-POS-Y" type="number" step="1" pattern="\d*" value="0"></text>
			<text>S: <input id="I-SCALE" type="number" step="0.0001" value="1"></text>
			<button onclick="editor_moveworkspace(); editor_scaleworkspace();">HOME</button>
		</panel>

		<!-- R/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: flex-start;">
			<text style="color:red;">-X</text>
		</panel>

		<!-- C/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: center;    "></panel>

		<!-- L/C --> <panel id="WORKSPACE-INFO" style="align-items: center;     justify-content: flex-end;  ">
			<text style="color:red;">+X</text>
		</panel>

		<!-- R/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: flex-start;">
		</panel>

		<!-- C/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: center;    ">
			<text style="color:lime;">-Y</text>
		</panel>

		<!-- L/B --> <panel id="WORKSPACE-INFO" style="align-items: flex-end;   justify-content: flex-end;  ">
		</panel>
	</panel>
	<panel style="display:block; width:25vw; height:100vh; background-color:white; border-left:3px solid black; z-index:5;">

	</panel>
</div>`;

function editor_create(){
	page("e");
}

const FILE_PROJECT_INPUT = document.getElementById("FILE_PROJECT_INPUT");
function editor_open_project(ProjectFile){
	if(ProjectFile.name.endsWith(FileExtension_Project)){
		log(`–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞ [${ProjectFile.name}]!`);
		editor_load(ProjectFile);
	}else{
		fatal(`–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –≤–∏–¥–µ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å —Ñ–æ—Ä–º–∞—Ç–æ–º "${FileExtension_Project}"!\nFILE_PROJECT_INPUT->change(${ProjectFile.name});`);
	}
}
FILE_PROJECT_INPUT.addEventListener("change", function(e) {
	if(e.target.files.length > 0){
		if(e.target.files.length === 1){
			editor_open_project(e.target.files[0]);
		}else{
			fatal(`–í—ã–±—Ä–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–µ–∫—Ç–æ–≤! –ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å 1!\nFILE_PROJECT_INPUT->change(${ProjectFile.name});`);
		}
	}
});
document.addEventListener("dragover", (e) => {
	e.preventDefault();
});
document.addEventListener("drop", (e) => {
	e.preventDefault();
	if(CurrentPage===""){
		editor_open_project(e.dataTransfer.files[0]);
	}
});

function editor_open(){
	FILE_PROJECT_INPUT.click();
}

function editor_make_unsave(){
	if(SAVED){
		SAVED = false;
		
		document.getElementById("SAVE").disabled = false;
		document.title = "MRC*";
	}
}

function get_png_dimension(content){
	return new Promise((resolve, reject) => {
		const blob = new Blob([content], { type: "image/png" });
		const url = URL.createObjectURL(blob);
		const img = new Image();
		img.onload = function(){
			URL.revokeObjectURL(url);
			const dimension = [img.width, img.height];
			URL.revokeObjectURL(url);
			resolve(dimension);
		}
		img.onerror = function(){
			URL.revokeObjectURL(url);
			reject(new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!"));
		}
		
		img.src = url;
	});
}

async function editor_save(){
	if(!SAVED){
		var loading = document.getElementById("LOADING");
		loading.innerText = "–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...";
		loading.style.display = "flex";
		try{
			function checkstring(s,sn,ifempty = null){ if(!s || s.trim()===""){ if(ifempty!=null){ return ifempty; }else{ throw new Error(`—Å—Ç—Ä–æ–∫–∞ "${sn}" –ø—É—Å—Ç–∞—è!`); } } return s; }
		
			checkstring(P_NAME   ,"–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞");
			P_AUTHOR  = checkstring(P_AUTHOR ,"–ê–≤—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞"   ,"Anonymous"    );
			P_LICENSE = checkstring(P_LICENSE,"–õ–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–æ–µ–∫—Ç–∞","Not specified");
		
			const zip = new JSZip();
			
			//CONTENT ->
			
			const content = zip.folder("Content");
			
			var files = {};
			
			for(var category in P_FILES){
				files[category] = [];
				var category_folder = content.folder(category);
				for(var i = 0; i < P_FILES[category].length; i++){
					var file = P_FILES[category][i];
					var file_content = file["Content"];
					if(file["ContentType"]==="byte"){
						file_content = new Uint8Array(file_content);
					}
					category_folder.file(file["Name"],file_content);
					delete file["Content"  ];
					delete file["Size"     ];
					delete file["Dimension"];
					delete file["URL"      ];
					files[category].push(file);
				}
			}
			
			zip.file("ProjectSettings", JSON.stringify({
				"Name": P_NAME,
				"Author": P_AUTHOR,
				"License": P_LICENSE,
				"MRC_Version": VERSION,
				"Categories": P_CATEGORIES,
				"Files": files
			}, null, 2));
			
			//<-
			
			const zip_content = await zip.generateAsync({ type: "blob" });
			const url = URL.createObjectURL(zip_content);
			const a = document.createElement("a");
			a.href = url;
			a.download = P_NAME + FileExtension_Project;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		
			SAVED = true;
			
			document.getElementById("SAVE").disabled = true;
			document.title = "MRC";
			loading.style.display = "none";
		}catch(e){
			loading.style.display = "none";
			fatal(`–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç, ${e}`);
		}
	}
}

async function editor_load(file){
	var loading = document.getElementById("LOADING");
	loading.style.display = "flex";
	try{
		const zip = await JSZip.loadAsync(file);
		
		async function checkfile(f,s){ if(!f){ throw new Error(`–§–∞–π–ª "${s}" –Ω–µ –Ω–∞–π–¥–µ–Ω!`); } var c = await f.async("text"); return c; }
		function checkkey(tabl,k,notfound = "NotFound"){ if(!tabl[k]){ warn(`–ù–µ –Ω–∞–π–¥–µ–Ω –∫–ª—é—á "${k}" –≤ —Ñ–∞–π–ª–µ!`); return notfound; } return tabl[k]; }
		
		const ProjectSettings_File = zip.file("ProjectSettings");
		const ProjectSettings_Content = await checkfile(ProjectSettings_File, "ProjectSettings");
		const ProjectSettings = JSON.parse(ProjectSettings_Content);
		
		log("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:");
		log(ProjectSettings);
		
		P_NAME    = checkkey(ProjectSettings,"Name");
		P_AUTHOR  = checkkey(ProjectSettings,"Author");
		P_LICENSE = checkkey(ProjectSettings,"License");
		var MRC_Version = checkkey(ProjectSettings,"MRC_Version","-1");
		P_CATEGORIES = checkkey(ProjectSettings,"Categories",["NotFound"]);
		
		var files_all = checkkey(ProjectSettings,"Files",{});
		P_FILES = {};
		var content = zip.folder("Content");
		async function processFiles() {
			for (var category in files_all) {
				if (P_CATEGORIES.includes(category)) {
					P_FILES[category] = [];
					var category_folder = content.folder(category);
					var files = files_all[category];

					var promises = files.map(async (file) => {
						var file_content = file["ContentType"] === "text" ? await category_folder.file(file["Name"]).async("text") : await category_folder.file(file["Name"]).async("uint8array");

						file["URL"    ] = null;
						file["Content"] = file_content;
						file["Size"   ] = file["ContentType"] === "byte" ? file_content.byteLength : file_content.length;

						if (file["Type"] === "texture") {
							try {
								var dimension = await get_png_dimension(file_content);
								file["Dimension"] = dimension;
							} catch (e) {
								console.error(`–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è [${file["Name"]}]! editor_load(${file});`);
							}
						} else {
							file["Dimension"] = null;
						}

						P_FILES[category].push(file);
					});

					await Promise.all(promises);
				} else {
					console.warn(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è [${category}] –≤ —Ñ–∞–π–ª–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);
				}
			}
		}
		processFiles().then(() => {
			for (var category in P_FILES) {
				P_FILES[category].sort((a,b) => a["ID"] - b["ID"]);
			}
		
			if(MRC_Version!==VERSION){ fatal(`–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏, –≤–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏! ${MRC_Version} != ${VERSION}`); }
		
			page("e");
		})
		.catch(e => {
			fatal(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤!`);
		});
	}catch(e){
		loading.style.display = "none";
		fatal(`–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç, ${e}`);
	}
}

const WindowWS = 1920;
const WindowHS =  916;
const WindowARS = WindowWS/WindowHS;

var WindowW = window.innerWidth;
var WindowH = window.innerHeight;
window.addEventListener("resize", function(e){
	var OldWindowW = WindowW;
	var OldWindowH = WindowH;
	WindowW = window.innerWidth;
	WindowH = window.innerHeight;

	var sx = WindowW/OldWindowW;
	var sy = WindowH/OldWindowH;

	var ar  = WindowW/WindowH;
	var ss = ar/WindowARS;

	if(CurrentPage==="e"){
		editor_moveworkspace(WorkspaceX * sx, WorkspaceY * sy);
	}
})

function calculate_background_position(){
	var x =  WorkspaceX;
	   x +=  WindowW/2 ;
	var xn = WorkspaceX;
	   xn -= WindowW/2 ;
	var y =  WorkspaceY;
	   y +=  WindowH/2 ;

	return [x,y,xn];
}

function calculate_elements_scale(){
	var result = 1/WorkspaceS;
	result *= 14*8;
	result *= (WindowW/WindowH)/WindowARS;
	return result;
}

var WorkspaceX = 0;
var WorkspaceY = 0;
/* –î–≤–∏–≥–∞—Ç—å —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
function editor_moveworkspace(newx = 0, newy = 0){
	WorkspaceX = newx;
	WorkspaceY = newy;

	var pos = calculate_background_position();
	PAGE.style.backgroundPosition = `right ${pos[0]}px top ${pos[1]}px`;

	document.getElementById("WORKSPACE-CONTENT").style.transform = `translate(${-pos[2]}px, ${pos[1]}px) scale(${calculate_elements_scale()}%)`;

	document.getElementById("I-POS-X").value = WorkspaceX;
	document.getElementById("I-POS-Y").value = WorkspaceY;
}

var WorkspaceS = 1;
function editor_scaleworkspace(news = 1){
	WorkspaceS = news;
	PAGE.style.backgroundSize = `${(1/WorkspaceS)*14*4}%`

	var pos = calculate_background_position();
	PAGE.style.backgroundPosition = `right ${pos[0]}px top ${pos[1]}px`;

	document.getElementById("WORKSPACE-CONTENT").style.transform = `translate(${-pos[2]}px, ${pos[1]}px) scale(${calculate_elements_scale()}%)`;

	document.getElementById("I-SCALE").value = WorkspaceS;
}

/* –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
function editor_add_element(id = null,style = null,content = null,posX = null,posY = null){
	if(id      === null){id      = "WORKSPACE-ELEMENT"};
	if(style   === null){style   = ""};
	if(content === null){content = ""};
	if(posX    === null){posX    = 0 };
	if(posY    === null){posY    = 0 };

	document.getElementById("WORKSPACE-CONTENT").innerHTML += `<element id="${id}" style="${style}">${content}</element>`;
}

function CLOSE_TOOLWINDOW(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.style.display = "none";
	TOOLWINDOW.innerHTML = "";
}

function editor_open_project_settings(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:40vw; height:30vh; margin-left:30vw; margin-top:35vh; padding:32px; box-sizing: border-box;">
	–ù–∞–∑–≤–∞–Ω–∏–µ:~<input type="text" id="I-PROJECTNAME"    maxlength="50" placeholder="New MRC Project" value="${P_NAME}" style="width:80%;"><br>
	–ê–≤—Ç–æ—Ä:~~~~<input type="text" id="I-PROJECTAUTHOR"  maxlength="50" placeholder="Anonymous" value="${P_AUTHOR}" style="width:80%;"><br>
	–õ–∏—Ü–µ–Ω–∑–∏—è:~<input type="text" id="I-PROJECTLICENSE" maxlength="50" placeholder="Not specified" value="${P_LICENSE}" style="width:80%;"><br>
	
	<br>
	
	<center><button onclick="CLOSE_TOOLWINDOW();">–ó–∞–∫—Ä—ã—Ç—å</button></center>
</div>`.replace(/~/g,"&nbsp;");
	
	document.getElementById("I-PROJECTNAME").addEventListener("input", function(e){
		const v = e.target.value.replace(/[^A-Za-z0-9 _]/g, '');
		e.target.value = v;
		P_NAME = v;
		editor_make_unsave();
	});
	document.getElementById("I-PROJECTAUTHOR").addEventListener("input", function(e){
		const v = e.target.value.replace(/["\\]/g, '');
		e.target.value = v;
		P_AUTHOR = v;
		editor_make_unsave();
	});
	document.getElementById("I-PROJECTLICENSE").addEventListener("input", function(e){
		const v = e.target.value.replace(/["\\]/g, '');
		e.target.value = v;
		P_LICENSE = v;
		editor_make_unsave();
	});
	
	TOOLWINDOW.style.display = "unset";
}

function editor_open_project_files_refresh(){
	document.getElementById("I-FILE-TABLE").innerHTML = "";
	if(!P_FILES[P_CATEGORIES[SelectedCategory]]){ P_FILES[P_CATEGORIES[SelectedCategory]] = []; }
	var total = 0;
	var total_there = 0;
	for(var category in P_FILES){
		var files = P_FILES[category];
		total += files.length;
		if(category === P_CATEGORIES[SelectedCategory]){
			total_there = files.length;
			for(var i = 0; i < files.length; i++){
				editor_open_project_files_addfile(files[i],category,i);
			}
		}
	}
	
	document.getElementById("I-FILES-TOTAL").innerText = total;
	document.getElementById("I-FILES-TOTAL-THERE").innerText = total_there;
}
function editor_open_project_files_remove_all(){
	const conf = confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—Å—ë —É–¥–∞–ª–∏—Ç—å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ [${P_CATEGORIES[SelectedCategory]}]?`);

	if(conf){
		for(var i = 0; i < P_FILES[P_CATEGORIES[SelectedCategory]].length; i++){
			var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
			if(file["URL"]){ URL.revokeObjectURL(file["URL"]); }
		}
		P_FILES[P_CATEGORIES[SelectedCategory]] = [];

		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_remove(i){
	const conf = confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å [${P_FILES[P_CATEGORIES[SelectedCategory]][i]["Name"]}]?`);

	if(conf){
		var file = P_FILES[P_CATEGORIES[SelectedCategory]][i];
		if(file["URL"]){ URL.revokeObjectURL(file["URL"]); }
	
		var files = P_FILES[P_CATEGORIES[SelectedCategory]];
		files.splice(i, 1);

		for (let j = i; j < files.length; j++) {
			files[j]["ID"] -= 1;
		}

		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_movefile(i,arrow){
	var newi = 0;
	switch(arrow){
		case 1 /* ‚Üê */: newi = i - 1 ; break;
		case 2 /* ‚Üì */: newi = i + 12; break; 
		case 3 /* ‚Üë */: newi = i - 12; break;
		case 4 /* ‚Üí */: newi = i + 1 ; break;
		default: break;
	}
	
	var files = P_FILES[P_CATEGORIES[SelectedCategory]];
	if(newi >= 0 && newi < files.length){
		var old = files[newi];
		files[newi] = files[i];
		files[i] = old;
		
		files[newi]["ID"] = newi;
		files[i]["ID"] = i;
		
		editor_open_project_files_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_files_addfile(f,category,i){
	var files_table = document.getElementById("I-FILE-TABLE");
	
	var element = document.createElement("file");
	
	element.style.backgroundColor = "rgba(255,255,255,0.9)";
	element.style.width    = "125px";
	element.style.height   = "140px";
	element.style.overflow = "hidden";
	
	var icon = "";
	
	if(f["Type"]==="texture"){
		var url = f["URL"];
		if(!url){
			const blob = new Blob([new Uint8Array(f["Content"])], { type: "image/png" });
			f["URL"] = URL.createObjectURL(blob);
		}
	
		icon = `<center style="width:100%; height:100%;"><img style="height:100%; width:100%;" src="${f["URL"]}"></center>`;
	}
	
	var title = `${category}/${f["Name"]}`;
	if(f["Type"]==="texture"){
		title += ` [${f["Dimension"][0]}x${f["Dimension"][1]}]`;
	}
	
	element.innerHTML = 
	`<div style="background-image:url('source/transparent.png'); width:100%; height:85%; cursor:help;" title="${title}">${icon}</div>
	<button onclick="editor_open_project_files_movefile(${i},1);">‚Üê</button><button onclick="editor_open_project_files_movefile(${i},2);">‚Üì</button><button onclick="editor_open_project_files_movefile(${i},3);">‚Üë</button><button onclick="editor_open_project_files_movefile(${i},4);">‚Üí</button><button style="font-size:0.5em;" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button><button style="font-size:0.5em;" title="–£–¥–∞–ª–∏—Ç—å" onclick="editor_open_project_files_remove(${i});">üóëÔ∏è</button>`;
	
	files_table.appendChild(element);
}
function editor_open_project_files_open(t){
	var input = document.getElementById("FILE_INPUT");
	
	//–û—á–∏—Å—Ç–∫–∞ –æ—Ç –∏–≤–µ–Ω—Ç–æ–≤
	const newinput = input.cloneNode(true);
	input.parentNode.replaceChild(newinput, input);
	input = newinput;
	
	function addfile(id,file){
		if(!P_FILES[P_CATEGORIES[SelectedCategory]]){ P_FILES[P_CATEGORIES[SelectedCategory]] = []; }
		
		var files = P_FILES[P_CATEGORIES[SelectedCategory]];
		var name = file.name.replace(/[^\x00-\x7F]/g, "-");
		
		const hasduplicates = files.some(item => item.Name === name);
		
		if(hasduplicates){
			fatal(`–§–∞–π–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º [${name}] —É–∂–µ –µ—Å—Ç—å!`);
		}else{
			const reader = new FileReader();
			var ThatByteArray = false;
			reader.onload = function(e){
				var content = e.target.result;
				var result = {
					"Name"       : name,
					"Type"       : id,
					"Size"       : (ThatByteArray ? content.byteLength : content.length),
					"ContentType": (ThatByteArray ? "byte" : "text"),
					"URL"        : null,
					"ID"         : P_FILES[P_CATEGORIES[SelectedCategory]].length,
					"Content"    : content
				};
				if(id==="texture"){
					get_png_dimension(content).then(dimension => {
						result["Dimension"] = dimension;
						P_FILES[P_CATEGORIES[SelectedCategory]].push(result);
					
						editor_open_project_files_refresh();
						editor_make_unsave();
					}).catch(e => {
						fatal(`–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è [${file["Name"]}]! addfile(${id},${file});`);
					})
				}else{
					result["Dimension"] = null;
					P_FILES[P_CATEGORIES[SelectedCategory]].push(result);
				
					editor_open_project_files_refresh();
					editor_make_unsave();
				}
			};
			if(id=="texture"||id=="sound"){
				ThatByteArray = true;
				reader.readAsArrayBuffer(file);
			}else{
				reader.readAsText(file, "UTF-8");
			}
		}
	}
	
	if(t==="i"){
		input.accept = ".png";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")){
					log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ [${ProjectFile.name}]!`);
					addfile("texture",ProjectFile);
				}else{
					fatal(`–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å —Ñ–æ—Ä–º–∞—Ç–æ–º ".png"!`);
				}
			}
		});
	}else if(t==="s"){
		input.accept = ".ogg";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".ogg")){
					log(`–î–æ–±–∞–≤–ª–µ–Ω –∑–≤—É–∫ [${ProjectFile.name}]!`);
					addfile("sound",ProjectFile);
				}else{
					fatal(`–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å —Ñ–æ—Ä–º–∞—Ç–æ–º ".ogg"!`);
				}
			}
		});
	}else{
		input.accept = "";
		input.addEventListener("change", function(e) {
			if(e.target.files.length === 1){
				const ProjectFile = e.target.files[0];
				if(ProjectFile.name.endsWith(".png")||ProjectFile.name.endsWith(".ogg")){
					fatal(`–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, —Å —Ñ–æ—Ä–º–∞—Ç–æ–º ".png" –∏–ª–∏ ".ogg"! (–≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏)`);
				}else{
					log(`–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∞–π–ª [${ProjectFile.name}]!`);
					addfile("other",ProjectFile);
				}
			}
		});
	}
	input.click();
}
var SelectedCategory = -1;
function editor_open_project_files_category_open(i){
	if(SelectedCategory!==i){
		if(SelectedCategory!=-1){
			document.getElementById(`I-CATEGORY-${SelectedCategory}`).disabled = false;
		}
		SelectedCategory = i;
		
		document.getElementById(`I-CATEGORY-${i}`).disabled = true;
		
		editor_open_project_files_refresh();
	}
}
function editor_open_project_files(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:90vw; height:90vh; margin-left:5vw; margin-top:5vh; padding:32px; box-sizing: border-box;">
	–î–æ–±–∞–≤–∏—Ç—å: <button onclick="editor_open_project_files_open('i');">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (.png)</button><button onclick="editor_open_project_files_open('s');">–ó–≤—É–∫ (.ogg)</button><button onclick="editor_open_project_files_open();">–û—Å—Ç–∞–ª—å–Ω–æ–µ</button>
	<br>
	<text style="color:red;">–í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ñ–∞–π–ª—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –≤—ã—Ö–æ–¥—è—â–∏–º–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã ASCII (–∫ –ø—Ä–∏–º–µ—Ä—É —Å –∫–∏—Ä—Ä–∏–ª–∏—Ü–µ–π –Ω–µ–ª—å–∑—è)</text>
	<br><br>
	<div style="width:95%; margin-left:2.5%; height:85%; background-color:rgba(0,0,0,0.25); display:flex; flex-direction:column;">
		<div style="width:100%; background-color:rgba(255,255,255,0.5);" id="I-CATEGORIES"></div>
		<div style="width:100%; flex:1; overflow-y:scroll; display: grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: 1fr; grid-gap: 5px; padding:5px;" id="I-FILE-TABLE"></div>
		<div style="width:100%; height: 1.25em; background-color:rgba(255,255,255,0.5);">
			–§–∞–π–ª–æ–≤ –≤—Å–µ–≥–æ: <text id="I-FILES-TOTAL">?</text> | 
			–§–∞–π–ª–æ–≤ —Ç—É—Ç: <text id="I-FILES-TOTAL-THERE">?</text> | 
			<button>–í—Å—ë —Ç—É—Ç –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button> | <button onclick="editor_open_project_files_remove_all();">–í—Å—ë —Ç—É—Ç —É–¥–∞–ª–∏—Ç—å</button> | 
			<button onclick="log(P_CATEGORIES);log(P_FILES);">DEBUG INFO</button>
		</div>
	</div>
	<br>
	<center><button onclick="CLOSE_TOOLWINDOW(); SelectedCategory=-1;">–ó–∞–∫—Ä—ã—Ç—å</button></center>
</div>`;
	
	var result_categ = `<button onclick="editor_open_project_categories(); SelectedCategory = -1;" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">‚úèÔ∏è</button> `;
	for(var i = 0; i < P_CATEGORIES.length; i++){
		var category = P_CATEGORIES[i];
		result_categ += `<button onclick="editor_open_project_files_category_open(${i});" id="I-CATEGORY-${i}">${i+1} : ${category}</button>`;
	}
	document.getElementById("I-CATEGORIES").innerHTML = result_categ;
	
	editor_open_project_files_category_open(0);
	
	TOOLWINDOW.style.display = "unset";
}

function editor_open_project_categories_delete(i){
	var files = P_FILES[P_CATEGORIES[i]];
	if(!files || files.length === 0){
		var category = P_CATEGORIES[i];
		if(P_FILES[category]){ delete P_FILES[category]; }
		P_CATEGORIES.splice(i, 1);
		editor_open_project_categories_refresh();
		editor_make_unsave();
	}else{
		fatal("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ø–æ—Ç–æ–º—É-—á—Ç–æ –≤ –Ω–µ–π –µ—Å—Ç—å —Ñ–∞–π–ª—ã!");
	}
}
function editor_open_project_categories_refresh(){
	var ic = document.getElementById("I-CATEGORIES");
	
	function addcategory_topanel(i){
		var category = P_CATEGORIES[i];
		
		var result = document.createElement("div");
		result.style.width = "100%";
		result.style.backgroundColor = `rgba(255,255,255,${i%2===0?0.5:0.3})`;
		
        result.appendChild(document.createTextNode(`${(i+1)<10?"0":""}${i+1} `));

        var downButton = document.createElement("button");
        downButton.textContent = "‚Üì";
		var downresult = i+2;
		if(i==P_CATEGORIES.length-1){ downresult = 1; }
		downButton.title = `–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ ${downresult < 10 ? "0" : ""}${downresult}`;
        downButton.onclick = function() {
            editor_open_project_categories_move(category, false);
        };
        result.appendChild(downButton);
		
		var upButton = document.createElement("button");
        upButton.textContent = "‚Üë";
		var upresult = i;
		if(i==0){ upresult = P_CATEGORIES.length; }
		upButton.title = `–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ ${upresult < 10 ? "0" : ""}${upresult}`;
        upButton.onclick = function() {
            editor_open_project_categories_move(category, true);
        };
        result.appendChild(upButton);
		
		result.appendChild(document.createTextNode(" "));

        var input = document.createElement("input");
        input.type = "text";
        input.value = category;
        input.style.width = "60%";
		input.maxLength = "30";
        input.id = `I-INPUT-${i}`;
		input.addEventListener("input", function(e){
			const v = e.target.value.replace(/[^A-Za-z0-9 _–ê-–Ø–∞-—è–Å—ë]/g, '');
			e.target.value = v;
			var oldcategory = P_CATEGORIES[i];
			P_CATEGORIES[i] = v;
			var files = P_FILES[oldcategory];
			if(files){
				delete P_FILES[oldcategory];
				P_FILES[v] = files;
			}
			editor_make_unsave();
		});
		input.addEventListener("blur", function(e){
			editor_open_project_categories_refresh();
		});
		result.appendChild(input);
		
		result.appendChild(document.createTextNode(" "));
		
		var deleteButton = document.createElement("button");
		deleteButton.textContent = "üóëÔ∏è";
		deleteButton.onclick = function(){
			editor_open_project_categories_delete(i);
		}
		result.appendChild(deleteButton);
		
		ic.appendChild(result);
	}
	
	ic.innerHTML = "";
	for(var i = 0; i < P_CATEGORIES.length; i++){
		addcategory_topanel(i);
	}
	
	document.getElementById("I-CATEGORIES-COUNT").innerText = P_CATEGORIES.length;
}
function editor_open_project_categories_move(category,up){
	const i = P_CATEGORIES.indexOf(category);
	
	if(up){
		if(i===0){
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.push(category);
		}else{
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.splice(i - 1, 0, category);
		}
	}else{
		if(i===P_CATEGORIES.length - 1){
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.unshift(category);
		}else{
			P_CATEGORIES.splice(i,1);
			P_CATEGORIES.splice(i + 1, 0, category);
		}
	}

	editor_open_project_categories_refresh();
	editor_make_unsave();
}
function editor_open_project_categories_create(){
	if(P_CATEGORIES.length < 30){
		P_CATEGORIES.push(`–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (${P_CATEGORIES.length+1})`);
		editor_open_project_categories_refresh();
		editor_make_unsave();
	}
}
function editor_open_project_categories_back(){
	if(P_CATEGORIES.length > 0){
		var hasduplicates = false;
	
		var seen = {};
		for(var i = 0; i < P_CATEGORIES.length; i++){
			var category = P_CATEGORIES[i];
			if(seen[category]){ hasduplicates = true; }
			seen[category] = true;
		}
	
		if(!hasduplicates){
			editor_open_project_files();
		}else{
			fatal("–ï—Å—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!");
		}
	}else{
		fatal("–ù—É–∂–Ω–æ –∏–º–µ–µ—Ç—å —Ö–æ—Ç—è-–±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é!");
	}
}
function editor_open_project_categories(){
	var TOOLWINDOW = document.getElementById("TOOL-WINDOW");
	TOOLWINDOW.innerHTML = 
`<div style="background-color:white; width:20vw; height:80vh; margin-left:40vw; margin-top:5vh; padding:16px; box-sizing: border-box;">
	<div style="width:95%; margin-left:2.5%; height:82.5%; background-color:rgba(0,0,0,0.25); overflow-y:scroll;" id="I-CATEGORIES"></div>
	<br>
	<center><text>–ö–∞—Ç–µ–≥–æ—Ä–∏–π: <text id="I-CATEGORIES-COUNT">?</text></text></center>
	<br>
	<center><button onclick="editor_open_project_categories_create();">–î–æ–±–∞–≤–∏—Ç—å</button></center>
	<br>
	<center><button onclick="editor_open_project_categories_back();">–ó–∞–∫—Ä—ã—Ç—å</button></center>
</div>`;
	
	editor_open_project_categories_refresh();
	
	TOOLWINDOW.style.display = "unset";
}

function INSTALL_PAGE_EDITOR(){
	var WORKSPACE = document.getElementById("WORKSPACE");
	var PAGE = document.getElementById("PAGE");

	var MouseDown = false;
	var ClickX = 0, ClickY = 0;
	PAGE.addEventListener("contextmenu", function(e){ e.preventDefault(); });
	WORKSPACE.addEventListener("mousedown", function(e){
		if(e.button === 2 && !MouseDown){ MouseDown = true; ClickX = e.clientX; ClickY = e.clientY;
			BODY.style.cursor = "grabbing";
			WORKSPACE.style.cursor = "grabbing";
		}
	});
	PAGE.addEventListener("mouseup", function(e){
		if(e.button === 2){ MouseDown = false;
			BODY.style.cursor = "default";
			WORKSPACE.style.cursor = "grab";
		}
	});
	PAGE.addEventListener("mousemove", function(e){
		if(MouseDown){
			const dx = e.clientX - ClickX;
			const dy = e.clientY - ClickY;

			WorkspaceX -= dx;
			WorkspaceY += dy;

			ClickX = e.clientX;
			ClickY = e.clientY;

			editor_moveworkspace(WorkspaceX, WorkspaceY);
		}
	});
	WORKSPACE.addEventListener("wheel", function(e){
		e.preventDefault();

		WorkspaceS *= e.deltaY > 0 ? 1.1 : 0.9;
		editor_scaleworkspace(WorkspaceS);
	});

	editor_moveworkspace(); editor_scaleworkspace();

	document.getElementById("I-POS-X").addEventListener("input", function(e){
		const v = parseInt(e.target.value,10);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			e.target.value = v;
			editor_moveworkspace(v, WorkspaceY);
		}
	});
	document.getElementById("I-POS-Y").addEventListener("input", function(e){
		const v = parseInt(e.target.value,10);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			e.target.value = v;
			editor_moveworkspace(WorkspaceX, v);
		}
	});
	document.getElementById("I-SCALE").addEventListener("input", function(e){
		const v = parseFloat(e.target.value);
		if(isNaN(v)){
			e.target.value = "";
		}else{
			v = Math.abs(v);
			if(v===0){v=1;}
			e.target.value = v;
			editor_scaleworkspace(v);
		}
	});

	editor_add_element("EL-CENTER",null,`<img style="width: 64px; height: 64px; transform: translate(-46.25%,-46.25%);" src="source/center.png">`,0,0);
}

document.addEventListener("keydown", function(e){
	if(CurrentPage==="e"){
		if(e.key === "Home"){ editor_moveworkspace(); editor_scaleworkspace(); }
	}
});
window.addEventListener("beforeunload",function(e){
	if(CurrentPage==="e" && !SAVED){
		e.preventDefault();
		e.returnValue = "";
	}
});

function page(id){
	var result = "ERROR";
	var func = function(){};
	CurrentPage = id;
	if(id==="e"){
		result = PAGE_EDITOR;
		func = INSTALL_PAGE_EDITOR;
	}else{
		result = PAGE_STARTPAGE;
		CurrentPage = "";
	}
	BODY.innerHTML = result;
	func();
}

var MS_LastTime = performance.now();
var MS = -1;
var MS_Count = 0;
function RenderLoop(){
	MS_Count++;

	var Now = performance.now();
	MS = Now - MS_LastTime;
	MS_LastTime = Now;

	if(MS_Count>5){
		var ms_label = document.getElementById("I-MS");
		if(ms_label){ ms_label.innerText = `${MS} ms (–Ω–æ—Ä–º:16-18)`; }
		MS_Count = 0;
	}

	requestAnimationFrame(RenderLoop);
}
requestAnimationFrame(RenderLoop);

//=============================
page();
</script>
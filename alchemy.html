<!DOCTYPE HTML>
<meta charset="utf-8">
<title>Woowz Alchemy</title>
<link rel="icon" type="image/x-icon" href="source/al.ico">

<style>
@font-face {
    font-family: "custom";
    src: url("source/Comfortaa.ttf") format('opentype');
}

html{
	background-image: url("source/grid.png");
	font-family: custom;
	cursor: default;
}

body{
	margin:0px;
	overflow: hidden;
	
	user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

::selection{
	background-color: transparent;
}
textarea::selection {
    background-color: blue;
	color:white;
}
input::selection {
    background-color: blue;
	color:white;
}

button{
	font-family: custom;
	font-size:2em;
	box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
	cursor:pointer;
}

input[type="checkbox"]{
	cursor:pointer;
}

* {
    -webkit-user-drag: none;
    user-drag: none;
    user-drag: none;
}

.element{
	transition: transform 0.3s;
	filter: drop-shadow(0px 0px 5px rgba(0,0,0,0.5));
}
.element:hover{
	transform: scale(1.2);
}

.rotate-slow {
    animation: rotate 30s linear infinite;
}
.rotate-fast {
    animation: rotate 0.3s linear infinite;
}
.energy {
    animation: rotate 0.15s linear infinite;
	filter: drop-shadow(0px 0px 20px rgba(255,255,0,1));
}
@keyframes rotate {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.size-slow {
    animation: size 15s linear infinite;
}
.size-fast {
    animation: size 1s linear infinite;
}
@keyframes size {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
    }
	100%{
		transform: scale(1);
	}
}

.light {
	filter: drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1));
	animation: light 60s linear infinite;
}
@keyframes light {
    0% {
        transform: scale(2) rotate(0deg);
    }
    50% {
        transform: scale(2.2) rotate(180deg);
    }
	100%{
		transform: scale(2) rotate(360deg);
	}
}

.dark {
	filter: drop-shadow(0px 0px 30px rgba(0,0,0,1)) drop-shadow(0px 0px 30px rgba(0,0,0,1));
	animation: bog 60s linear infinite;
}

.bog {
	filter: drop-shadow(0px 0px 5px rgba(255,255,255,1)) drop-shadow(0px 0px 5px rgba(255,255,0,1));
	animation: bog 60s linear infinite;
}
@keyframes bog {
    0% {
        transform: scale(1.5) rotate(0deg);
    }
    50% {
        transform: scale(1.7) rotate(180deg);
    }
	100%{
		transform: scale(1.5) rotate(360deg);
	}
}

.fire {
	filter: drop-shadow(0px 0px 100px rgba(255,255,0,1)) drop-shadow(0px 0px 5px rgba(255,255,0,1)) drop-shadow(0px 0px 7px rgba(255,128,0,1)) drop-shadow(0px 0px 10px rgba(255,0,0,1));
	animation: rand-height 5s linear infinite;
}
@keyframes rand-height {
    0%   { transform: scaleY(1    ); }
	10%  { transform: scaleY(1.1  ); }
	20%  { transform: scaleY(1.05 ); }
	30%  { transform: scaleY(0.95 ); }
	40%  { transform: scaleY(1.05 ); }
	50%  { transform: scaleY(1.05 ); }
	60%  { transform: scaleY(1.075); }
	70%  { transform: scaleY(0.975); }
	80%  { transform: scaleY(1.05 ); }
	90%  { transform: scaleY(1.025); }
	100% { transform: scaleY(0.975); }
}

.shake {
	animation: shake 1s linear infinite;
}
@keyframes shake {
    0%   { transform: translateY(0%); }
	10%  { transform: translateY(1%); }
	20%  { transform: translateY(-0.5%); }
	30%  { transform: translateY(1.5%); }
	40%  { transform: translateY(-0.5%); }
	50%  { transform: translateY(1%); }
	60%  { transform: translateY(-1%); }
	70%  { transform: translateY(1.5%); }
	80%  { transform: translateY(0%); }
	90%  { transform: translateY(-7%); }
	100% { transform: translateY(-3%); }
}

.electr {
	animation: electr 0.5s linear infinite;
}
@keyframes electr {
    0%   { filter: drop-shadow(0px 0px 60px rgba(128,128,255,1)); }
	20%  { filter: drop-shadow(0px 0px 80px rgba(200,230,255,1)); }
	40%  { filter: drop-shadow(0px 0px 70px rgba(200,200,255,1)); }
	60%  { filter: drop-shadow(0px 0px 50px rgba(100,100,255,1)); }
	80%  { filter: drop-shadow(0px 0px 60px rgba(255,128,255,1)); }
	100% { filter: drop-shadow(0px 0px 70px rgba(200,200,255,1)); }
}

.glow-purple {
	filter: drop-shadow(0px 0px 100px rgba(255,0,255,1)) drop-shadow(0px 0px 30px rgba(255,0,255,1));
}

</style>

<body>
	<div id="mainmenu" style="position:fixed; background-image:url('source/wall.png'); width:100vw; height:100vh; text-shadow: 0px 5px 10px rgba(0, 0, 0, 0.4); z-index:3000;">
		<font style="position:fixed; right:50%; transform: translateX(50%); margin-top:5vh; font-size:5em; white-space: nowrap;"><b>⚗️ Woowz Alchemy ⚗️</b></font>
		<font style="position:fixed; right:50%; transform: translateX(50%); margin-top:17vh; font-size:3em; white-space: nowrap;"><b>Версия: <font id="version">?.?.?</font></b></font>
		
		<div style="position:fixed; right:50%; transform: translateX(50%); bottom:30%;">
			<button style="width:30vw; min-width:500px; margin-top:30px;" onclick="StartGame(null);">Начать новую игру</button><br>
			<button style="width:30vw; min-width:500px; margin-top:30px;" onclick="StartGameWithSave();">Загрузить игру</button><br>
			<button style="width:30vw; min-width:500px; margin-top:30px;">Настройки</button>
		</div>
		
		<div style="position:fixed; right:50px; bottom:10%;">
			<textarea id="generated-recipes" style="width:30vw; height:70vh; resize: none; overflow-y:scroll; word-wrap: normal;" spellcheck="false" rows="4" colds="50"></textarea><br>
			<font id="error" style="color:red; font-size:1.2em; display:none;"><b>ОШИБКА ПРИ КОМПИЛЯЦИИ РЕЦЕПТОВ! СМ. F12</b></font>
		</div>
		
		<font style="position:fixed; right:10px; bottom:10px; font-size:2em; white-space: nowrap;">Сделано Woowz11</font>
	</div>

	<div style="background-color:rgb(200,200,200); box-shadow: 5px 0px 10px rgba(0, 0, 0, 0.2); height:100vh; width:36.5%; display: inline-block;">
		<div style="height:15%; padding-left:2.5%; position: relative;">
			<button style="width:60%; font-size:1.2em; margin-top:10px;">Подсказка</button>
			<input type="checkbox" id="sort-checkbox" style="transform: scale(1.15);"><font>В алфавитном порядке</font><br>
			<input type="text" id="search" autocomplete="off" spellcheck="false" placeholder="Поиск..." style="width:94%; margin-top:5px; height:30px; font-size:1.2em;"><br>
			<div style="background-color:rgb(220,220,220); border-radius:20px; width:95%; height:6vh; margin-top:10px; margin-bottom:10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2); text-align:center; padding:5px;">
				<font><b id="desc"></b></font>
			</div>
		</div>
		<div style="height:calc(100% - 15% - 15%); padding:20px;">
			<div style="background-color:rgba(0,0,0,0.2); width:100%; height:100%; border-radius: 20px; box-shadow: inset 0 0 10px 10px rgba(0, 0, 0, 0.2); overflow: hidden; overflow-y: scroll;">
				<div id="inventory" style="height:auto; width:95%; margin-left:calc(5% / 2); margin-top:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); grid-auto-rows: 55px;"></div>
			</div>
		</div>
		<div style="height:10%; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); grid-gap: 5px; margin-left:20px; margin-right:20px;">
			<button style="font-size:16px;" onclick="GoToMainMenu();">Выйти в меню</button>
			<button style="font-size:16px;" onclick="SaveGame();">Сохранить<font id="save" style="display:none;">*</font></button>
			<button style="font-size:16px;" onclick="ClearTable();">Очистить стол</button>
			<button style="font-size:16px;">Настройки</button>
			<button style="font-size:16px;">История</button>
			<button style="font-size:16px;">Рецепты</button>
		</div>
	</div>
	
	<div_ id="table" style="height:100vh; width:calc(100% - 37%); white-space: nowrap;"></div_>
	
	<font style="position:fixed; right:10px; top:10px; font-size:1.5em; white-space: nowrap; z-index:-1; color:rgba(0,0,0,0.3); text-align: center;"><b>Woowz Alchemy<br>Версия: <font id="version">?.?.?</font><br><font id="dev" style="color:red;"></font></b></font>
	
	<font style="position:fixed; right:10px; bottom:10px; font-size:1.5em; white-space: nowrap; z-index:-1; color:rgba(0,0,0,0.3); text-align: center;"><b>На сцене: <font id="total-in-table">0</font><br>Элементов: <font id="open-elements">?</font>/<font id="total-elements">?</font><br>Рецептов: <font id="open-recipes">0</font>/<font id="total-recipes">?</font></b></font>
	
	<div id="dev-tool" style="position:fixed; background-color:rgba(200,200,200,0.9); width:auto; height:300px; top:100px; right:10px; text-align: center; display:none;">
		<font>Отладка</font><br>
		<button style="font-size:1.5em;" onclick="DebugOpenAll();">Открыть всё</button>
	</div>
	
	<input id="file-input" type="file" style="display:none;" accept=".woowzalchemy">
</body>
<script src=".\woowzsite-private\alchemy.js"></script> <!-- F:\woowzsite-private\alchemy.js | .\woowzsite-private\alchemy.js -->

<script>

const GameVersion = "0.0.1";
const DevMode = false;
/*Не забудь изменить скрипт с указания папки на ссылку!*/

document.querySelectorAll("#version").forEach(function(element){
    element.innerText = GameVersion;
});
if(DevMode){
	document.getElementById("dev").innerText="!Режим отладки!";
	document.getElementById("dev-tool").style.display = "unset";
}else{
	document.getElementById("generated-recipes").style.display = "none";
}

var ElementsOnTable = [];
var ElementsOnTableIDS = 0;
var SelectedElement = null;
var zindex = 2000;
var ElementsDatas = {};
var OpenElements = {};
var RecipesDatas = {};
var OpenRecipes = {};
var needsave = false;

var sort_alphaphyte = false;
var search_applying = false;

var MouseOffsetX = 0; var MouseOffsetY = 0;

function SortAlphaphyte(){
	var grid = document.getElementById("inventory");
	var elements = Array.from(grid.children);
	
	elements.sort((a,b) => ElementsDatas[a.getAttribute("elementid")]["Name"].localeCompare(ElementsDatas[b.getAttribute("elementid")]["Name"]));
	
	elements.forEach(el => grid.appendChild(el));
}

function ChangeSortAlphaphyte(){
	sort_alphaphyte = document.getElementById("sort-checkbox").checked;
	if(sort_alphaphyte){
		SortAlphaphyte();
	}else{
		var grid = document.getElementById("inventory");
		var elements = Array.from(grid.children);
		console.log(OpenElements);
		
		elements.sort((a,b) => OpenElements[a.getAttribute("elementid")] - OpenElements[b.getAttribute("elementid")]);
		
		elements.forEach(el => grid.appendChild(el));
	}
}
document.getElementById("sort-checkbox").addEventListener('change',function(){ ChangeSortAlphaphyte(); });

function ApplySearch(){
	var text = document.getElementById("search").value.toLowerCase();

	if(search_applying==false&&text!=""){ search_applying=true; }
	if(search_applying){
		var grid = document.getElementById("inventory");
		var elements = Array.from(grid.children);
		
		for(var el of elements){
			var name = ElementsDatas[el.getAttribute("elementid")]["Name"].toLowerCase();
			el.style.display = (name.includes(text)?"unset":"none");
		}
		
		if(search_applying&&text==""){ search_applying=false; }
	}
}
document.getElementById("search").addEventListener('input',function(){ApplySearch();});

function CreateElement(id){
	ElementsOnTableIDS++;
	return {"id":id,"name":id,"number":ElementsOnTableIDS};
}

function ClearTable(){
	var elot = [...ElementsOnTable];
	for(var el of elot){
		RemoveElementFromTable(el["number"]);
	}
}

function AddRecipe(recipe,result){
	OpenRecipes[recipe] = result;
	document.getElementById("open-recipes").innerText = Object.keys(OpenRecipes).length;
	needsave = true;
	document.getElementById("save").style.display = "unset";
	
	var elements_ = recipe.split("+");
	
	var dif = {};
	for(const key in RecipesDatas){
		if(RecipesDatas[key] !== OpenRecipes[key]){
			dif[key] = RecipesDatas[key];
		}
	}
	var notendcraft1 = false;
	var notendcraft2 = false;
	for(var recipe in dif){
		var elements = recipe.split("+");
		if(elements[0]==elements_[0]||elements[1]==elements_[0]){
			notendcraft1 = true;
		}
		if(elements[0]==elements_[1]||elements[1]==elements_[1]){
			notendcraft2 = true;
		}
	}
		
	if(notendcraft1==false){
		document.getElementById(elements_[0]+"_END2").style.display = "unset";
	}
	if(notendcraft2==false){
		document.getElementById(elements_[1]+"_END2").style.display = "unset";
	}
}

function CheckRecipe(id1,id2){
	var result = null;
	var recipe = id1+"+"+id2;
	result = RecipesDatas[recipe];
	if(result==null){recipe = id2+"+"+id1;result = RecipesDatas[recipe];}
	if(OpenRecipes[recipe]==null&&result!=null){
		AddRecipe(recipe,result);
	}
	if(result!=null){
		for(var el of result){
			if(OpenElements[el]==null){
				AddElementToInventory(el);
			}
		}
	}
	return result;
}

function CombineElements(el1,el2,distance){
	if(el1!=null&&el2!=null&&distance<90){
		var id1 = GetElementDataById(el1.id)["number"]; var id2 = GetElementDataById(el2.id)["number"];
		var result = CheckRecipe(GetElementDataById(el1.id)["id"],GetElementDataById(el2.id)["id"]);
		if(result!=null){
			result.sort(()=> Math.random()-0.5);
			var rect1 = el1.getBoundingClientRect();
			var rect2 = el2.getBoundingClientRect();
			var x = rect1.left/2+rect2.left/2;
			var y = rect1.top/2+rect1.top/2;
			RemoveElementFromTable(id1);
			RemoveElementFromTable(id2);
			for(var el of result){
				AddElementToTable(el,x,y);
			}
		}
	}
}

function SelectElement(id,event,dontmouseoffset){
	var el = document.getElementById(id);
	if(dontmouseoffset!=true){
		var rect = el.getBoundingClientRect();
		MouseOffsetX = event.clientX - rect.left;
		MouseOffsetY = event.clientY - rect.top;
	}
	SelectedElement = el;
	zindex++;
	SelectedElement.style.zIndex = zindex;
}
document.addEventListener('mouseup', function(event) {
    if (event.button == 0 && SelectedElement!=null) {
		var rect1 = SelectedElement.getBoundingClientRect();
		var x1 = rect1.left + rect1.width / 2;
		var y1 = rect1.top + rect1.height / 2;

		var nearimage = null;
		var minDistance = Number.MAX_VALUE;
		for(var eldata of ElementsOnTable){
			var el = document.getElementById(eldata["number"]);
			var rect2 = el.getBoundingClientRect();
			var x2 = rect2.left + rect2.width / 2;
			var y2 = rect2.top + rect2.height / 2;
			
			var distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
			if(distance<minDistance && el != SelectedElement){
				minDistance = distance;
				nearimage = el;
			}
		}
		CombineElements(SelectedElement,nearimage,minDistance);
        SelectedElement = null;
		MouseOffsetX = 0; MouseOffsetY = 0;
    }
});
document.addEventListener('mousemove', function(event) {
    if(SelectedElement){
		SelectedElement.style.left = (event.clientX-MouseOffsetX)+"px";
		SelectedElement.style.top = (event.clientY-MouseOffsetY)+"px";
	}
});

var initialWindowWidth = window.innerWidth;
var initialWindowHeight = window.innerHeight;
window.addEventListener('resize', function() {
	for(var el of ElementsOnTable){
		var el_ = document.getElementById(el["number"]);
		if(el_!=null){
			var rect = el_.getBoundingClientRect();
			var leftResult = Math.floor(rect.left*(window.innerWidth/initialWindowWidth));
			var topResult = Math.floor(rect.top*(window.innerHeight/initialWindowHeight));
			el_.style.left = leftResult + 'px';
			el_.style.top = topResult + 'px';
		}
	}
	
	initialWindowWidth = window.innerWidth;
    initialWindowHeight = window.innerHeight;
});

function GetElementDataById(id){
	var foundElement = ElementsOnTable.find(function(element) {
		return element.number == id;
	});
	return foundElement;
}

function CloneElement(id){
	var el = document.getElementById(id);
	var rect = el.getBoundingClientRect();
	var eldata = GetElementDataById(id);
	AddElementToTable(eldata["id"],rect.left+30,rect.top-30,true);
}

function AddElementToTable(id,posx,posy,z_top){
	var el = CreateElement(id);
	var elid = el["number"];
	ElementsOnTable.push(el);
	var result = `<div id="`+elid+`" class="element" style="position:fixed; left:`+posx+`px; top:`+posy+`px;"><img `+(ElementsDatas[id]["Class"]==null?"":`class="`+ElementsDatas[id]["Class"]+`"`)+` style="width:100px; height:100px; border-radius: 20%; cursor:pointer;" draggable="false" title="`+ElementsDatas[id]["Name"]+`" onerror="this.src='alchemy/dev.png';" src="alchemy/`+id+`.`+(ElementsDatas[id]["Gif"]==true?"gif":"png")+`"></div>`;
	document.getElementById("table").innerHTML += result;
	var el_ = document.getElementById(elid);
	if(z_top==true){
		zindex++;
		el_.style.zIndex = zindex;
	}
}
document.getElementById("table").addEventListener("mousedown", function(event) {
	if(event.button == 0){
		if(event.target!=null){
			var id = event.target.id;
			if(id==""){
				id = event.target.parentNode.id;
			}
			SelectElement(id,event);
		}
	}
});
document.getElementById("table").addEventListener('dblclick', function(event) {
	if(event.button == 0){
		var id = event.target.id;
		if(id==""){
			id = event.target.parentNode.id;
		}
		CloneElement(id);
	}
});
function hasParentWithId(element, parentId) {
    var parent = element.parentNode;
    while (parent) {
        if (parent.id === parentId) {
            return parent;
        }
        parent = parent.parentNode;
    }
    return null;
}
document.getElementById("inventory").addEventListener("mousedown", function(event) {
	if(event.button == 0){
		var got = hasParentWithId(event.target,"got");
		if(got != null){
			if(got.id == "got"){
				GetElementFromInventory(event,got.getAttribute("elementid"),false,got);
			}
		}
	}
});
var desc = document.getElementById("desc");
document.addEventListener("mousemove", function(event) {
	var id = "";
	if(event.target!=null){
		var got = hasParentWithId(event.target,"got");
		if(got != null){
			if(got.id == "got"){
				id = got.getAttribute("elementid");
			}
		}
	}
	var d = "";
	if(id!=""){
		if(ElementsDatas[id]["Desc"]!=null){
			d = ElementsDatas[id]["Desc"];
		}
	}
	desc.innerHTML = d;
});

function RemoveElementFromTable(id){
	document.getElementById(id).remove();
	var foundIndex = ElementsOnTable.findIndex(function(element) {
		return element.number === id;
	});
	ElementsOnTable.splice(foundIndex,1);
}

function PerSecond(){
	for(var el of ElementsOnTable){
		var el_ = document.getElementById(el["number"]);
		var rect = el_.getBoundingClientRect();
		var remove = false;
		if(rect.left>window.innerWidth||rect.top>window.innerHeight||rect.left<0||rect.top<-100){
			remove = true;
		}
		
		if(remove){
			if(el_!=SelectedElement){
				RemoveElementFromTable(el["number"]);
			}
		}
	}
	
	document.getElementById("total-in-table").innerText = ElementsOnTable.length;
}
setInterval(PerSecond,1000);

function DebugOpenAll(){
	if(DevMode){
		for(var key in RecipesDatas){
			var val = RecipesDatas[key];
			for(var result of val){
				AddElementToInventory(result);
			}
			AddRecipe(key,val);
		}
	}
}

function StartGame(save){
	document.getElementById("mainmenu").style.display = "none";
	
	for(var eldata of AlchemyElements){
		if(eldata["Start"]==true){ AddElementToInventory(eldata["Id"]); }
	}
	if(save!=null){
		var save_recipes = save.split(",");
		
		for(var recipe of save_recipes){
			if(RecipesDatas[recipe]!=null){
				var results = RecipesDatas[recipe];
				for(var result of results){
					AddElementToInventory(result);
				}
				AddRecipe(recipe,results)
			}
		}
		needsave = false;
		document.getElementById("save").style.display = "none";
	}
	
	document.getElementById("search").value = "";
	ApplySearch();
}

function StartGameWithSave(){
	var save = localStorage.getItem("alchemy_save");
	StartGame((save==null?null:save));
}

function GetElementFromInventory(event,id,justclick,el){
	if(event.button == 0){
		var rect = el.getBoundingClientRect();
		MouseOffsetX = event.clientX - rect.left;
		MouseOffsetY = event.clientY - rect.top;
		AddElementToTable(id,event.clientX - MouseOffsetX,event.clientY - MouseOffsetY);
		SelectElement(ElementsOnTableIDS,event,true);
	}
}

window.addEventListener('beforeunload', function (e) {
	if(needsave){
		e.preventDefault();
		e.returnValue = '';
	}
});

function LoadingMainMenu(){
	document.getElementById("mainmenu").style.display = "unset";
	ClearTable();
	OpenRecipes = {};
	OpenElements = {};
	document.getElementById("inventory").innerHTML = "";
	
	needsave = false;
	document.getElementById("save").style.display = "none";
}

function GoToMainMenu(){
	var gotomenu = false;
	if(needsave){
		const result = confirm("Вы не сохранили прогресс, продолжить выход?");
		if(result){
			gotomenu = true;
		}
	}else{
		gotomenu = true;
	}
	if(gotomenu){
		LoadingMainMenu();
	}
}

function SaveGame(){
	var save_recipes = "";
	
	for(var recipeid in OpenRecipes){
		save_recipes += ((save_recipes==""?"":",") + recipeid)
	}
	
	if(DevMode){
		console.log("Сохранено:",save_recipes);
	}
	localStorage.setItem("alchemy_save",save_recipes)
	
	needsave = false;
	document.getElementById("save").style.display = "none";
}

function AddElementToInventory(id){
	if(OpenElements[id]==null){
		var name = ElementsDatas[id]["Name"];
		var result = `<div id="got" elementid="`+id+`" title="`+name+`" style="text-align:center; cursor:pointer; z-index:`+Math.floor(1000+Math.random()*100)+`;"><div><div class="element"><img id="`+id+`_END" src="alchemy/that_end2.png" style="position:fixed; width:50px; height:50px; z-index:10; display:none;"><img id="`+id+`_END2" src="alchemy/that_end.png" style="position:fixed; width:50px; height:50px; z-index:10; display:none;"><img `+(ElementsDatas[id]["Class"]==null?"":`class="`+ElementsDatas[id]["Class"]+`"`)+` style="width:50px; height:50px; border-radius: 20%;" draggable="false" onerror="this.src='alchemy/dev.png';" src="alchemy/${id}.`+(ElementsDatas[id]["Gif"]==true?"gif":"png")+`"></div></div></div>`;
		document.getElementById("inventory").innerHTML += result;
		OpenElements[id] = Object.keys(OpenElements).length+1;
		document.getElementById("open-elements").innerText = Object.keys(OpenElements).length;
		if(sort_alphaphyte){
			SortAlphaphyte();
		}
		ApplySearch();
	}
	var hascraft = false;
	for(var recipe in RecipesDatas){
		var elements = recipe.split("+");
		if(elements[0]==id||elements[1]==id){
			hascraft = true;
		}
	}
	if(hascraft==false){
		document.getElementById(id+"_END").style.display = "unset";
	}
}
document.getElementById("total-elements").innerText = AlchemyElements.length;
document.getElementById("total-recipes").innerText = AlchemyRecipes.length;

for(var eldata of AlchemyElements){
	ElementsDatas[eldata["Id"]] = eldata;
}

for(var recipe of AlchemyRecipes){
	var craft = recipe.split("=");
	RecipesDatas[craft[0]] = craft[1].split(",");
}

if(DevMode){
	var wetrecipesresult = "";
	
	let values = {};
	var AlchemyRecipesWet_ = [];
	for (let str of AlchemyRecipesWet) {
		str = str.toLowerCase();
		let parts = str.split("=");
		let parts2 = parts[0].split("+");

		var error = false;
		if(ElementsDatas[parts2[0]]==null&&!/\{.*\}/.test(parts2[0])){
			console.log(`РЕЦЕПТ: РЕЦЕПТ (`+str+`) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ПЕРВЫЙ ЭЛЕМЕНТ (`+parts2[0]+`) НЕИЗВЕСТЕН!`)
			error = true;
		}
		if(ElementsDatas[parts2[1]]==null&&!/\{.*\}/.test(parts2[1])){
			console.log(`РЕЦЕПТ: РЕЦЕПТ (`+str+`) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ВТОРОЙ ЭЛЕМЕНТ (`+parts2[1]+`) НЕИЗВЕСТЕН!`)
			error = true;
		}
		var results = parts[1].split(",");
		for(var result of results){
			if(ElementsDatas[result]==null){
				console.log(`РЕЦЕПТ: РЕЦЕПТ (`+str+`) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ЭЛЕМЕНТ ИЗ РЕЗУЛЬТАТА (`+result+`) НЕИЗВЕСТЕН!`)
				error = true;
			}
		}
		
		if (values[parts2[0]+"+"+parts2[1]]!=null||values[parts2[1]+"+"+parts2[0]]!=null) {
			var val = values[parts2[0]+"+"+parts2[1]];
			if(val==null){val=values[parts2[1]+"+"+parts2[0]];}
			error = true;
			console.log(`РЕЦЕПТ: РЕЦЕПТ (`+str+`) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ УЖЕ ЕСТЬ РЕЦЕПТ (`+val+`)!`);
		} else {
			values[parts2[0]+"+"+parts2[1]] = str;
			if(error==false){
				AlchemyRecipesWet_.push(str);
			}
		}
		
		if(error){
			document.getElementById("error").style.display = "unset";
		}
	}
	
	var wetrecipes = [];
	var t = 0;
	var t_max = 3;
	for(var wetrecipe of AlchemyRecipesWet_){
		var recipe = wetrecipe.split("=");
		var elements = recipe[0].split("+");
		var el1 = elements[0];
		var el2 = elements[1];
		var result = recipe[1].split(",")
		
		var el1_group = /\{.*\}/.test(el1);
		var el2_group = /\{.*\}/.test(el2);
		if(el1_group||el2_group){
			var el1_ = (el1_group?el1.slice(1,-1):el1);
			var el2_ = (el2_group?el2.slice(1,-1):el2);
			var group1 = (el1_group?AlchemyGroups[el1_]:[el1]);
			var group2 = (el2_group?AlchemyGroups[el2_]:[el2]);
			for(var x of group1){
				for(var y of group2){
					wetrecipes.push(x+"+"+y+"="+recipe[1]);
				}
			}
		}else{
			wetrecipes.push(wetrecipe);
		}
	}
	
	var recipes_ = {};
	for(var recipe of wetrecipes){
		var r = recipe.split("=");
		var elements = r[0].split("+");
		if(recipes_[r[0]]==null&&recipes_[elements[1]+"+"+elements[0]]==null){
			recipes_[r[0]] = r[1];
		}
	}
	
	for(var key in recipes_){
		var val = recipes_[key];
		t++;
		wetrecipesresult += "\""+key+"="+val+"\","+(t>=t_max?"\n":"");
		if(t>=t_max){
			t = 0;
		}
	}
	
	document.getElementById("generated-recipes").innerHTML = wetrecipesresult.slice(0, -1);;
}

</script>
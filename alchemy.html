<!DOCTYPE HTML>
<meta charset="utf-8">
<title>Woowz Alchemy</title>
<link rel="icon" type="image/x-icon" href="source/al.ico">

<style>
:root{
	--DisableHover: false;
}

@font-face {
    font-family: "custom";
    src: url("source/Comfortaa.ttf") format('opentype');
}

html{
	background-image: url("source/grid.png");
	font-family: custom;
	cursor: default;
}

body{
	margin: 0;
	overflow: hidden;
	width: 100%;
	height: 100%;
	
	user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

::selection{
	background-color: transparent;
}

textarea::selection {
    background-color: blue;
	color:white;
}

input::selection {
    background-color: blue;
	color:white;
}

button{
    font-family: custom;
    font-size: 2em;
    box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.2);
	cursor: pointer;
}
button:disabled{
	cursor: default;
}

input[type="checkbox"]{
	cursor: pointer;
}

* {
    -webkit-user-drag: none;
    user-drag: none;
    user-drag: none;
}

.elementbase{
	text-algin: center;
	cursor: pointer;
}

:root[DisableHover="true"] .elementbase{
	pointer-events: none;
	cursor: unset;
}

.element{
	width:50px; height:50px;
	transition: transform 0.3s;
	cursor: pointer;
}

.element:hover{
	transform: scale(1.2);
}

:root[DisableHover="true"] .element{
	pointer-events: none;
}

warning_screensize {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	background-color: rgba(255, 0, 0, 1);
	color: white;
	font-size: 24px;
	justify-content: center;
	align-items: center;
	text-align: center;
	z-index: 10000;
}

@media (max-width: 1000px), (max-height: 600px) {
	warning_screensize {
		display: flex;
	}
}

warning_mobile {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100vw;
	height: 100vh;
	background-color: rgba(0, 0, 255, 1);
	color: white;
	font-size: 24px;
	justify-content: center;
	align-items: center;
	text-align: center;
	z-index: 10001;
}

/*-------------------------------------------------------------------------*/

.rotate-slow{
    animation: rotate 30s linear infinite;
}
.rotate-fast{
    animation: rotate 1s linear infinite;
}
.energy{
    animation: rotate 0.1s linear infinite;
	filter: drop-shadow(0px 0px 20px rgba(255,255,0,1));
}
@keyframes rotate{
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.size-slow {
    animation: size 15s linear infinite;
}
.size-fast {
    animation: size 1s linear infinite;
}
@keyframes size {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.15);
    }
	100%{
		transform: scale(1);
	}
}

.size-slow-and-rotate{
    animation: size-rotate 30s linear infinite;
}
@keyframes size-rotate {
    0% {
        transform: scale(1) rotate(0deg);
    }
    25% {
        transform: scale(1.15) rotate(90deg);
    }
	50%{
		transform: scale(1) rotate(180deg);
	}
	75% {
        transform: scale(1.15) rotate(270deg);
    }
    100% {
        transform: scale(1) rotate(360deg);
    }
}

.light {
	filter: drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1)) drop-shadow(0px 0px 30px rgba(255,255,255,1));
	animation: light 60s linear infinite;
}
@keyframes light {
    0% {
        transform: scale(1) rotate(0deg);
    }
    50% {
        transform: scale(1.2) rotate(180deg);
    }
	100%{
		transform: scale(1) rotate(360deg);
	}
}

.dark {
	filter: drop-shadow(0px 0px 30px rgba(0,0,0,1)) drop-shadow(0px 0px 30px rgba(0,0,0,1));
	animation: bog 60s linear infinite;
}
.dark2 {
	filter: drop-shadow(0px 0px 30px rgba(0,0,0,1)) drop-shadow(0px 0px 30px rgba(0,0,0,1));
}

.bog {
	filter: drop-shadow(0px 0px 5px rgba(255,255,255,1)) drop-shadow(0px 0px 5px rgba(255,255,0,1));
	animation: bog 60s linear infinite;
}
@keyframes bog {
    0% {
        transform: scale(1) rotate(0deg);
    }
    50% {
        transform: scale(1.2) rotate(180deg);
    }
	100%{
		transform: scale(1) rotate(360deg);
	}
}

.fire {
	filter: drop-shadow(0px 0px 100px rgba(255,255,0,1)) drop-shadow(0px 0px 5px rgba(255,255,0,1)) drop-shadow(0px 0px 7px rgba(255,128,0,1)) drop-shadow(0px 0px 10px rgba(255,0,0,1));
	animation: rand-height 5s linear infinite;
}
@keyframes rand-height {
    0%   { transform: scaleY(1    ); }
	10%  { transform: scaleY(1.1  ); }
	20%  { transform: scaleY(1.05 ); }
	30%  { transform: scaleY(0.95 ); }
	40%  { transform: scaleY(1.05 ); }
	50%  { transform: scaleY(1.05 ); }
	60%  { transform: scaleY(1.075); }
	70%  { transform: scaleY(0.975); }
	80%  { transform: scaleY(1.05 ); }
	90%  { transform: scaleY(1.025); }
	100% { transform: scaleY(0.975); }
}

.shake {
	animation: shake 1s linear infinite;
}
@keyframes shake {
    0%   { transform: translateY(0%); }
	10%  { transform: translateY(1%); }
	20%  { transform: translateY(-0.5%); }
	30%  { transform: translateY(1.5%); }
	40%  { transform: translateY(-0.5%); }
	50%  { transform: translateY(1%); }
	60%  { transform: translateY(-1%); }
	70%  { transform: translateY(1.5%); }
	80%  { transform: translateY(0%); }
	90%  { transform: translateY(-7%); }
	100% { transform: translateY(-3%); }
}

.electr {
	animation: electr 0.5s linear infinite;
}
@keyframes electr {
    0%   { filter: drop-shadow(0px 0px 60px rgba(128,128,255,1)); }
	20%  { filter: drop-shadow(0px 0px 80px rgba(200,230,255,1)); }
	40%  { filter: drop-shadow(0px 0px 70px rgba(200,200,255,1)); }
	60%  { filter: drop-shadow(0px 0px 50px rgba(100,100,255,1)); }
	80%  { filter: drop-shadow(0px 0px 60px rgba(255,128,255,1)); }
	100% { filter: drop-shadow(0px 0px 70px rgba(200,200,255,1)); }
}

.glow-purple {
	filter: drop-shadow(0px 0px 100px rgba(246,84,255,1)) drop-shadow(0px 0px 30px rgba(246,84,255,1));
}
.glow-pink {
	filter: drop-shadow(0px 0px 100px rgba(255,175,214,1)) drop-shadow(0px 0px 30px rgba(255,175,214,1));
}
.glow-teen {
	filter: drop-shadow(0px 0px 100px rgba(255,224,216,1)) drop-shadow(0px 0px 30px rgba(255,224,216,1));
}
.glow-aqua {
	filter: drop-shadow(0px 0px 100px rgba(163,186,255,1)) drop-shadow(0px 0px 30px rgba(163,186,255,1));
}
.glow-lime {
	filter: drop-shadow(0px 0px 100px rgba(0,255,0,1)) drop-shadow(0px 0px 30px rgba(0,255,0,1));
}
.glow-red {
	filter: drop-shadow(0px 0px 100px rgba(255,0,0,1)) drop-shadow(0px 0px 30px rgba(255,0,0,1));
}
.glow-orange {
	filter: drop-shadow(0px 0px 100px rgba(255,128,0,1)) drop-shadow(0px 0px 30px rgba(255,128,0,1));
}

.hot {
	filter: drop-shadow(0px 0px 50px rgba(255,0,0,1));
}
.cold {
	filter: drop-shadow(0px 0px 50px rgba(0,0,255,1));
}

</style>

<body>
	<warning_screensize>Измените размер экрана, что-бы играть в игру!</warning_screensize>
	<warning_mobile>Игра не работает с телефона!</warning_mobile>

	<div id="mainmenu" style="position:fixed; background-image:url('source/wall.png'); width:100vw; height:100vh; text-shadow: 0px 5px 10px rgba(0, 0, 0, 0.4); z-index:3000;">
		<font style="position:fixed; right:50%; transform: translateX(50%); margin-top:5vh; font-size:5em; white-space: nowrap;"><b>⚗️ Woowz Alchemy ⚗️</b></font>
		<font style="position:fixed; right:50%; transform: translateX(50%); margin-top:17vh; font-size:3em; white-space: nowrap;"><b>Версия: <font id="version">?.?.?</font></b></font>
		
		<div style="position:fixed; right:50%; transform: translateX(50%); bottom:30%;">
			<button style="width:30vw; min-width:500px; margin-top:30px;" onclick="StartGame(null);">Начать новую игру</button><br>
			<button style="width:30vw; min-width:500px; margin-top:30px;" onclick="StartGameWithSave();" id="loadgame-button">Загрузить игру</button><br>
			<button style="width:30vw; min-width:500px; margin-top:30px;" disabled>Настройки</button>
		</div>
		
		<div style="position:fixed; right:50px; bottom:60px; width:30vw; height:92vh;">
			<textarea id="generated-recipes" style="height:85%; width:100%; resize:none; overflow:scroll; word-wrap:normal; display:none;" spellcheck="false" rows="4" colds="50" readonly></textarea><br>
			<font id="error" style="color:red; font-size:1.2em; display:none;"><b>ОШИБКА ПРИ КОМПИЛЯЦИИ РЕЦЕПТОВ! СМ. F12</b></font><br>
			<div style="white-space:wrap; margin-top:10px; background-color:black;"><font style="color:yellow; font-size:1.2em;"><b id="error-text"></b></font></div>
		</div>
		
		<font style="position:fixed; right:10px; bottom:10px; font-size:2em; white-space: nowrap;">Сделано Woowz11</font>
	</div>
	
	<div id="tool-window" style="position:fixed; width:100vw; height:100vh; z-index:3000; background-color:rgba(0,0,0,0.25); display:none;"></div>

	<div style="background-color:rgb(200,200,200); box-shadow: 5px 0px 10px rgba(0, 0, 0, 0.2); height:100vh; width:36.5%; display: inline-block;">
		<div style="height:15%; padding-left:2.5%; position: relative; text-wrap:nowrap;">
			<input type="checkbox" id="sort-checkbox" style="margin-top:10px; transform: scale(1.15);"><font>В алфавитном порядке</font><br>
			<input type="text" id="search" autocomplete="off" spellcheck="false" placeholder="Поиск..." style="width:95.5%; margin-top:5px; height:30px; font-size:1.2em;"><br>
			<div style="background-color:rgb(220,220,220); border-radius:10px; width:95.5%; height:40%; margin-top:10px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2); text-align:center; text-wrap:wrap; padding:5px;">
				<font><b id="desc-elementname"></b></font><br>
				<hr style="color:rgba(0,0,0,0.25);">
				<font><b id="desc"></b></font>
			</div>
		</div>
		<div style="height:calc(100% - 15% - 15%); padding:20px;">
			<div style="background-color:rgba(0,0,0,0.2); width:100%; height:100%; border-radius: 10px; box-shadow: inset 0 0 10px 10px rgba(0, 0, 0, 0.2); overflow: hidden; overflow-y: scroll;">
				<div id="inventory" style="height:auto; width:95%; margin-left:calc(5% / 2); margin-top:15px; display:grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); grid-auto-rows: 55px;"></div>
			</div>
		</div>
		<div style="height:10%; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); grid-gap: 5px; margin-left:20px; margin-right:20px;">
			<button style="font-size:16px;" onclick="GoToMainMenu();">Выйти в меню</button>
			<button style="font-size:16px;" onclick="SaveGame();">Сохранить<font id="save" style="display:none;">*</font></button>
			<button style="font-size:16px;" onclick="ClearTable();">Очистить стол</button>
			<button style="font-size:16px;" onclick="History();">История</button>
			<button style="font-size:16px;" onclick="Recipes();">Рецепты</button>
			<button style="font-size:16px;" disabled>Подсказка</button>
		</div>
	</div>
	
	<div_ id="table" style="height:100vh; width:calc(100% - 37%); white-space: nowrap;"></div_>
	
	<font style="position:fixed; right:10px; top:10px; font-size:1.5em; white-space: nowrap; z-index:-1; color:rgba(0,0,0,0.3); text-align: center;"><b>Woowz Alchemy<br>Версия: <font id="version">?.?.?</font><br><font id="dev" style="color:red;"></font></b></font>
	
	<font id="fps-font" style="position:fixed; left:37%; top:10px; font-size:1.5em; white-space: nowrap; z-index:-1; color:rgba(0,0,0,0.3); text-align: left;"><b>MS: <font id="fps">?</font></b></font>
	
	<div style="position:fixed; left:37%; bottom:10px; font-size:1.5em; white-space: nowrap; text-align: left; color:rgba(0,0,0,0.3);">
		<b id="last5" style="opacity:0.2"></b>
		<br>
		<b id="last4" style="opacity:0.4"></b>
		<br>
		<b id="last3" style="opacity:0.6"></b>
		<br>
		<b id="last2" style="opacity:0.8"></b>
		<br>
		<b id="last1"></b>
	</div>
	
	<font style="position:fixed; right:10px; bottom:10px; font-size:1.5em; white-space: nowrap; z-index:-1; color:rgba(0,0,0,0.3); text-align: center;"><b>На сцене: <font id="total-in-table">0</font><br>Элементов: <font id="open-elements">?</font>/<font id="total-elements">?</font><br>Рецептов: <font id="open-recipes">0</font>/<font id="total-recipes">?</font></b></font>
	
	<div id="dev-tool" style="position:fixed; background-color:rgba(200,200,200,0.9); width:auto; height:auto; top:100px; right:10px; text-align: center; z-index:100; display:none;">
		<font>Отладка</font><br>
		<button style="font-size:1.5em; width:100%;" onclick="DebugOpenAll();">Открыть всё</button><br>
		<button style="font-size:1.5em; width:100%;" disabled>Открыть случайно</button><br>
		<button style="font-size:1.5em; width:100%;" disabled>Открыть рецепт</button><br>
		<button style="font-size:1.5em; width:100%;" disabled>Клонировать стол</button><br>
		<button style="font-size:1.5em; width:100%;" disabled>Случайный элемент</button><br>
	</div>
	
	<input id="file-input" type="file" style="display:none;" accept=".woowzalchemy">
</body>

<script>

const GameVersion = "0.0.3";
var DevMode = true;
/*Не забудь изменить скрипт с указания папки на ссылку! Сделал это автоматическим, можешь забить*/

/*Настройки*/

var EnableClasses      = 1   ; // 0 [0-2] : Включает визуальные эффекты элементам [0 - Влючает всё, 1 - Включает только на рабочем столе, 2 - Выключает всё]
var ShowClosedElements = true; // true    : Включает отображение звёздочек рядом с элементами, что обозначает что это конечный элемент или рецепты закончились
var ShowFPS            = true; // true    : Отображать фпс или нет
var CompactElements    = 0   ; // 0 [0-2] : Делает элементы в инвенторе простыми внешним видом [0 - Выключено, 1 - Случайные цвета, 2 - Радужные цвета]

/*=========*/

var ElementsOnTable = [];
var ElementsOnTableIDS = 0;
var SelectedElement = null;
var zindex = 2000;
var ElementsDatas = {};
var OpenElements = {};
var RecipesDatas = {};
var OpenRecipes = {};
var needsave = false;
var thatLocalFile = window.location.protocol === "file:";
var thatPhone = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
if(thatPhone){
	var style = `warning_mobile {
		display: flex;
	}`;
	var STYLE = document.createElement("style");
	STYLE.type = "text/css";
	if(STYLE.styleSheet){
		STYLE.styleSheet.cssText = style;
	}else{
		STYLE.appendChild(document.createTextNode(style));
	}
	document.head.appendChild(STYLE);
}
if(!thatLocalFile){
	if(DevMode){
		DevMode = false;
	}
}

var InToolWindow = false;

document.querySelectorAll("#version").forEach(function(element){
    element.innerText = GameVersion;
});
if(DevMode){
	document.getElementById("dev").innerText="!Режим отладки!";
	document.getElementById("dev-tool").style.display = "unset";
	document.getElementById("generated-recipes").style.display = "unset";
}
if(!ShowFPS){
	document.getElementById("fps-font").style.display = "none";
}

var sort_alphaphyte = false;
var search_applying = false;

document.getElementById("sort-checkbox").checked = false;

var MouseOffsetX = 0; var MouseOffsetY = 0;

function SortAlphaphyte(){
	var grid = document.getElementById("inventory");
	var elements = Array.from(grid.children);
	
	elements.sort((a,b) => ElementsDatas[a.getAttribute("elementid")]["Name"].localeCompare(ElementsDatas[b.getAttribute("elementid")]["Name"]));
	
	elements.forEach(el => grid.appendChild(el));
}

var last_recipe5 = "";
var last_recipe4 = "";
var last_recipe3 = "";
var last_recipe2 = "";
var last_recipe1 = "";
function UpdateLastRecipeFonts(newrecipe, new_el, new_r, text_ = null){
	var res = "";
	if(newrecipe === ""){
		last_recipe5 = "";
		last_recipe4 = "";
		last_recipe3 = "";
		last_recipe2 = "";
		last_recipe1 = "";
	}else{
		if(text_){
			last_recipe5 = last_recipe4;
			last_recipe4 = last_recipe3;
			last_recipe3 = last_recipe2;
			last_recipe2 = last_recipe1;
			last_recipe1 = text_;
			res = text_;
		}else{
			var elements = newrecipe.split("+");
			var results = RecipesDatas[newrecipe];
			var text = `${ElementsDatas[elements[0]]["Name"]} + ${ElementsDatas[elements[1]]["Name"]} = `;
			var s = false;
			for(var el of results){
				text += (s ? ", " : "") + ElementsDatas[el]["Name"];
				s = true;
			}
			last_recipe5 = last_recipe4;
			last_recipe4 = last_recipe3;
			last_recipe3 = last_recipe2;
			last_recipe2 = last_recipe1;
			last_recipe1 = text;
			if(text.length > 60){
				text = text.substring(0,57) + "...";
			}
			res = (new_el || new_r ? `<text style="color:red;">${new_el ? "E" : "R"}</text> ` : "") + text;
		}
	}
	document.getElementById("last5").innerHTML = document.getElementById("last4").innerHTML;
	document.getElementById("last5").title = last_recipe5;
	document.getElementById("last4").innerHTML = document.getElementById("last3").innerHTML;
	document.getElementById("last4").title = last_recipe4;
	document.getElementById("last3").innerHTML = document.getElementById("last2").innerHTML;
	document.getElementById("last3").title = last_recipe3;
	document.getElementById("last2").innerHTML = document.getElementById("last1").innerHTML;
	document.getElementById("last2").title = last_recipe2;
	document.getElementById("last1").innerHTML = res;
	document.getElementById("last1").title = last_recipe1;
}

function ChangeSortAlphaphyte(){
	sort_alphaphyte = document.getElementById("sort-checkbox").checked;
	if(sort_alphaphyte){
		SortAlphaphyte();
	}else{
		var grid = document.getElementById("inventory");
		var elements = Array.from(grid.children);
		
		elements.sort((a,b) => OpenElements[a.getAttribute("elementid")] - OpenElements[b.getAttribute("elementid")]);
		
		elements.forEach(el => grid.appendChild(el));
	}
}
document.getElementById("sort-checkbox").addEventListener('change',function(){ ChangeSortAlphaphyte(); });

function ApplySearch(){
	var text = document.getElementById("search").value.toLowerCase();

	if(search_applying === false && text !== ""){ search_applying = true; }
	if(search_applying){
		var grid = document.getElementById("inventory");
		var elements = Array.from(grid.children);
		
		for(var el of elements){
			var name = ElementsDatas[el.getAttribute("elementid")]["Name"].toLowerCase();
			el.style.display = (name.includes(text) ? "unset" : "none");
		}
		
		if(search_applying && text === ""){ search_applying = false; }
	}
}
document.getElementById("search").addEventListener('input',function(){ApplySearch();});

function CreateElement(id){
	ElementsOnTableIDS++;
	return {
		"id"     : id,
		"name"   : id,
		"number" : ElementsOnTableIDS
	};
}

function ClearTable(){
	var elot = [...ElementsOnTable];
	for(var el of elot){
		RemoveElementFromTable(el["number"]);
	}
}

function AddRecipe(recipe,result){
	OpenRecipes[recipe] = result;
	document.getElementById("open-recipes").innerText = Object.keys(OpenRecipes).length;
	needsave = true;
	document.getElementById("save").style.display = "unset";
	document.title = "Woowz Alchemy*";
	
	var elements_ = recipe.split("+");
	
	var dif = {};
	for(const key in RecipesDatas){
		if(RecipesDatas[key] !== OpenRecipes[key]){
			dif[key] = RecipesDatas[key];
		}
	}
	var notendcraft1 = false;
	var notendcraft2 = false;
	for(var recipe in dif){
		var elements = recipe.split("+");
		if(elements[0] == elements_[0] || elements[1] == elements_[0]){
			notendcraft1 = true;
		}
		if(elements[0] == elements_[1] || elements[1] == elements_[1]){
			notendcraft2 = true;
		}
	}
		
	if(notendcraft1==false&&document.getElementById(`${elements_[0]}_END2`) && ShowClosedElements){
		document.getElementById(`${elements_[0]}_END2`).style.display = "unset";
	}
	if(notendcraft2==false&&document.getElementById(`${elements_[1]}_END2`) && ShowClosedElements){
		document.getElementById(`${elements_[1]}_END2`).style.display = "unset";
	}
}

function CheckRecipe(id1,id2){
	var result = null;
	var recipe = `${id1}+${id2}`;
	result = RecipesDatas[recipe];
	if(!result){recipe = `${id2}+${id1}`; result = RecipesDatas[recipe];}
	var new_el = false;
	var new_r = false;
	if(result){
		for(var el of result){
			if(OpenElements[el] == null){
				AddElementToInventory(el);
				new_el = true;
			}
		}
	}
	if(!OpenRecipes[recipe] && result){
		AddRecipe(recipe,result);
		new_r = true;
	}
	if(result){
		UpdateLastRecipeFonts(recipe, new_el, new_r);
	}
	return result;
}

var combine_result_rastoanie = 100;
function CombineElements(el1, el2, distance){
	if(el1 && el2 && distance < 90){
		var id1 = GetElementDataById(el1.id)["number"];
		var id2 = GetElementDataById(el2.id)["number"];
		var result = CheckRecipe(GetElementDataById(el1.id)["id"],GetElementDataById(el2.id)["id"]);
		if(result){
			result.sort(() => Math.random() - 0.5);
			var rect1 = el1.getBoundingClientRect();
			var rect2 = el2.getBoundingClientRect();
			var x = rect1.left / 2 + rect2.left / 2;
			var y = rect1.top  / 2 + rect1.top  / 2;
			RemoveElementFromTable(id1);
			RemoveElementFromTable(id2);
			var count = result.length;
			var deg_offset = Math.random() * 360;
			var c = -1;
			for(var el of result){
				c++;
				var deg = Math.round((c/count) * 360 + deg_offset);
				var x_ = x + Math.sin(deg * Math.PI / 180) * (count === 1 ? 0 : combine_result_rastoanie);
				var y_ = y + Math.cos(deg * Math.PI / 180) * (count === 1 ? 0 : combine_result_rastoanie);
				AddElementToTable(el, x_, y_);
			}
		}
	}
}

function SelectElement(id, event, dontmouseoffset){
	var el = document.getElementById(id);
	if(dontmouseoffset !== true){
		var rect = el.getBoundingClientRect();
		MouseOffsetX = event.clientX - rect.left;
		MouseOffsetY = event.clientY - rect.top;
	}
	SelectedElement = el;
	zindex++;
	SelectedElement.style.zIndex = zindex;
}
document.addEventListener("mouseup", function(event) {
    if (event.button == 0 && SelectedElement) {
		var rect1 = SelectedElement.getBoundingClientRect();
		var x1 = rect1.left + rect1.width  / 2;
		var y1 = rect1.top  + rect1.height / 2;

		var nearimage = null;
		var minDistance = Number.MAX_VALUE;
		for(var eldata of ElementsOnTable){
			var el = document.getElementById(eldata["number"]);
			var rect2 = el.getBoundingClientRect();
			var x2 = rect2.left + rect2.width  / 2;
			var y2 = rect2.top  + rect2.height / 2;
			
			var distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
			if(distance < minDistance && el !== SelectedElement){
				minDistance = distance;
				nearimage   = el;
			}
		}
		CombineElements(SelectedElement,nearimage,minDistance);
        SelectedElement = null;
		MouseOffsetX = 0; MouseOffsetY = 0;
    }
});
document.addEventListener("mousemove", function(event) {
    if(SelectedElement){
		SelectedElement.style.left = `${event.clientX-MouseOffsetX + 10}px`;
		SelectedElement.style.top  = `${event.clientY-MouseOffsetY + 10}px`;
	}
});

var initialWindowWidth = window.innerWidth;
var initialWindowHeight = window.innerHeight;
window.addEventListener("resize", function() {
	for(var el of ElementsOnTable){
		var el_ = document.getElementById(el["number"]);
		if(el_){
			var rect = el_.getBoundingClientRect();
			var leftResult = Math.floor(rect.left * (window.innerWidth  / initialWindowWidth ));
			var topResult  = Math.floor(rect.top  * (window.innerHeight / initialWindowHeight));
			el_.style.left = `${leftResult}px`;
			el_.style.top  = `${topResult}px`;
		}
	}
	
	initialWindowWidth = window.innerWidth;
    initialWindowHeight = window.innerHeight;
});

function GetElementDataById(id){
	var foundElement = ElementsOnTable.find(function(element) {
		return element.number == id;
	});
	return foundElement;
}

function CloneElement(id){
	var el = document.getElementById(id);
	var rect = el.getBoundingClientRect();
	var eldata = GetElementDataById(id);
	var deg = Math.round(Math.random() * 360);
	var x = rect.left + 10 + Math.sin(deg * Math.PI / 180) * combine_result_rastoanie;
	var y = rect.top  + 10 + Math.cos(deg * Math.PI / 180) * combine_result_rastoanie;
	AddElementToTable(eldata["id"],x,y,true);
}

function AddElementToTable(id, posx, posy, z_top){
	var el = CreateElement(id);
	var elid = el["number"];
	ElementsOnTable.push(el);
	var scale = ElementsDatas[id]["Scale"] || 1;
	var shadow = ElementsDatas[id]["Shadow"] || true;
	var result = 
	`<div id="${elid}" class="element" elementid="${id}" style="position:fixed; left:${posx}px; top:${posy}px; width:100px; height:100px; z-index:2000; ${shadow ? "filter: drop-shadow(0px 0px 5px rgba(0,0,0,0.5));" : ""}" title="${ElementsDatas[id]["Name"]}">
		<div style="pointer-events: none; transform: scale(${scale});">
			<img ${ElementsDatas[id]["Class"] == null || EnableClasses > 1 ? "" : "class=\"" + ElementsDatas[id]["Class"] + "\""} style="width:100px; height:100px; border-radius: 20%; cursor:pointer;" draggable="false" title="${ElementsDatas[id]["Name"]}" onerror="this.src='alchemy/dev.png';" src="alchemy/${id}.${ElementsDatas[id]["Gif"] == true ? "gif" : "png"}">
		</div>
	</div>`;
	document.getElementById("table").innerHTML += result;
	var el_ = document.getElementById(elid);
	if(z_top==true){
		zindex++;
		el_.style.zIndex = zindex;
	}
}
document.getElementById("table").addEventListener("mousedown", function(event) {
	if(event.button == 0 && !InToolWindow){
		if(event.target){
			var id = event.target.id;
			if(id == ""){
				id = event.target.parentNode.id;
			}
			SelectElement(id, event);
		}
	}
});
document.getElementById("table").addEventListener("dblclick", function(event) {
	if(event.button == 0 && !InToolWindow){
		var id = event.target.id;
		if(id == ""){
			id = event.target.parentNode.id;
		}
		CloneElement(id);
	}
});
function hasParentWithId(element, parentId) {
    var parent = element.parentNode;
    while (parent) {
        if (parent.id === parentId) {
            return parent;
        }
        parent = parent.parentNode;
    }
    return null;
}

function hasAttributeFromParents(element, att){
	var parent = element;
	while(parent){
		if(parent instanceof Element){
			if(parent.hasAttribute(att)){
				return parent;
			}
		}
		parent = parent.parentNode;
	}
	return null;
}

document.getElementById("inventory").addEventListener("mousedown", function(event) {
	if(event.button == 0 && !InToolWindow){
		var got = hasParentWithId(event.target, "got");
		if(got){
			if(got.id == "got"){
				GetElementFromInventory(event, got.getAttribute("elementid"), false, got);
			}
		}
	}
});
var descelname = document.getElementById("desc-elementname");
var desc = document.getElementById("desc");
document.addEventListener("mousemove", function(event) {
	var id = "";
	if(event.target){
		var got = hasAttributeFromParents(event.target, "elementid");
		if(got){
			id = got.getAttribute("elementid");
		}
	}
	var d = "";
	var name = "";
	if(id !== ""){
		if(ElementsDatas[id]["Name"]){
			name = ElementsDatas[id]["Name"] + (DevMode ? ` (${ElementsDatas[id]["ID"]})` : "");
		}
		if(ElementsDatas[id]["Desc"]){
			d = ElementsDatas[id]["Desc"];
		}
	}
	descelname.innerHTML = name;
	desc.innerHTML = d;
});

function RemoveElementFromTable(id){
	document.getElementById(id).remove();
	var foundIndex = ElementsOnTable.findIndex(function(element) {
		return element.number === id;
	});
	ElementsOnTable.splice(foundIndex,1);
}

function PerSecond(){
	for(var el of ElementsOnTable){
		var el_ = document.getElementById(el["number"]);
		var rect = el_.getBoundingClientRect();
		var remove = false;
		if(rect.left + 10 > window.innerWidth || rect.top + 10 > window.innerHeight || rect.left + 10 < 0 || rect.top + 10 < -100){
			remove = true;
		}
		
		if(remove){
			if(el_ !== SelectedElement){
				RemoveElementFromTable(el["number"]);
			}
		}
	}
	
	document.getElementById("total-in-table").innerText = ElementsOnTable.length;
}
setInterval(PerSecond,1000);

var fps_font = document.getElementById("fps");
var MS_LastTime = performance.now();
var MS = -1;
var MS_Count = 0;
function RenderLoop(){
	MS_Count++;

	var Now = performance.now();
	MS = Now - MS_LastTime;
	MS_LastTime = Now;

	if(MS_Count>5){
		if(fps_font){ fps_font.innerText = `${MS} ms`; }
		MS_Count = 0;
	}

	requestAnimationFrame(RenderLoop);
}
requestAnimationFrame(RenderLoop);

function DebugOpenAll(){
	if(DevMode){
		for(var key in RecipesDatas){
			var val = RecipesDatas[key];
			for(var result of val){
				AddElementToInventory(result);
			}
			AddRecipe(key,val);
		}
	}
}

function StartGame(save){
	document.getElementById("mainmenu").style.display = "none";
	
	for(var eldata of AlchemyElements){
		if(eldata["Start"] == true){ AddElementToInventory(eldata["ID"]); }
	}
	if(save){
		var save_recipes = save.split(",");
		
		for(var recipe of save_recipes){
			if(RecipesDatas[recipe]!=null){
				var results = RecipesDatas[recipe];
				for(var result of results){
					AddElementToInventory(result);
				}
				AddRecipe(recipe,results)
			}
		}
		needsave = false;
		document.getElementById("save").style.display = "none";
		document.title = "Woowz Alchemy";
		UpdateLastRecipeFonts("");
	}
	
	document.getElementById("search").value = "";
	ApplySearch();
}

function StartGameWithSave(){
	var save = localStorage.getItem("alchemy_save");
	StartGame(!save ? null : save);
}

function GetElementFromInventory(event,id,justclick,el){
	if(event.button === 0){
		var rect = el.getBoundingClientRect();
		MouseOffsetX = 50
		MouseOffsetY = 50
		AddElementToTable(id,event.clientX - MouseOffsetX,event.clientY - MouseOffsetY);
		SelectElement(ElementsOnTableIDS,event,true);
	}
}

window.addEventListener("beforeunload", function (e) {
	if(needsave){
		e.preventDefault();
		e.returnValue = "";
	}
});

function LoadingMainMenu(){
	document.getElementById("mainmenu").style.display = "unset";
	ClearTable();
	OpenRecipes  = {};
	OpenElements = {};
	document.getElementById("inventory").innerHTML = "";
	
	needsave = false;
	document.getElementById("save").style.display = "none";
	document.title = "Woowz Alchemy";
	
	document.getElementById("loadgame-button").disabled = (!localStorage.getItem("alchemy_save") || localStorage.getItem("alchemy_save") === "");
}
document.getElementById("loadgame-button").disabled = (!localStorage.getItem("alchemy_save") || localStorage.getItem("alchemy_save") === "");


function GoToMainMenu(){
	var gotomenu = false;
	if(needsave){
		const result = confirm("Вы не сохранили прогресс, продолжить выход?");
		if(result){
			gotomenu = true;
		}
	}else{
		gotomenu = true;
	}
	if(gotomenu){
		LoadingMainMenu();
	}
}

function SaveGame(){
	if(needsave){
		var save_recipes = "";
		
		for(var recipeid in OpenRecipes){
			save_recipes += ((save_recipes==""?"":",") + recipeid)
		}
		
		if(DevMode){
			console.log("Сохранено:",save_recipes);
		}
		localStorage.setItem("alchemy_save",save_recipes)
		
		needsave = false;
		document.getElementById("save").style.display = "none";
		document.title = "Woowz Alchemy";
		
		UpdateLastRecipeFonts(null,null,null,"Игра сохранена!");
	}
}

function EnableToolWindow(Inner){
	if(!InToolWindow){
		var tool_window = document.getElementById("tool-window");
		
		tool_window.innerHTML = Inner;
		
		document.documentElement.setAttribute("DisableHover", "true");
		
		tool_window.style.display = "unset";
		InToolWindow = true;
	}
}

function DisableToolWindow(){
	if(InToolWindow){
		var tool_window = document.getElementById("tool-window");
		tool_window.style.display = "none";
		tool_window.innerHTML = "";
		InToolWindow = false;
		
		document.documentElement.setAttribute("DisableHover", "false");
	}
}

function History(){
	EnableToolWindow(
	`<div style="background-color:white; width:70%; height:95%; margin-left:15%; margin-top:1.25%;">
		<button onclick="DisableToolWindow();">Обратно</button>
	</div>`
	);
}

function Recipes(){
	EnableToolWindow(
	`<div style="background-color:white; width:70%; height:95%; margin-left:15%; margin-top:1.25%;">
		<button onclick="DisableToolWindow();">Обратно</button>
	</div>`
	);
}

var sortedalp = null;

function RefreshElementsInInventory(){
	if(CompactElements > 1){
		for(var i in sortedalp){
			var el = sortedalp[i];
			var id = el["ID"];
			
			var el_ = document.getElementById(`${id}-COMPACTICON`);
			if(el_){
				const key = i / AlchemyElements.length; 
					
				const colors = [
					{ r: 255, g: 0  , b: 0  },
					{ r: 255, g: 128, b: 0  },
					{ r: 255, g: 255, b: 0  },
					{ r: 128, g: 255, b: 0  },
					{ r: 0  , g: 255, b: 0  },
					{ r: 0  , g: 255, b: 128},
					{ r: 0  , g: 255, b: 255},
					{ r: 0  , g: 128, b: 255},
					{ r: 0  , g: 0  , b: 255},
					{ r: 128, g: 0  , b: 255},
					{ r: 255, g: 0  , b: 255},
					{ r: 255, g: 0  , b: 128},
					{ r: 255, g: 255, b: 255},
					{ r: 192, g: 192, b: 192},
					{ r: 128, g: 128, b: 128},
					{ r: 64 , g: 64 , b: 64 },
					{ r: 0  , g: 0  , b: 0  },
				];
				
				const segmentCount = colors.length - 1;
				const segmentSize = 1 / segmentCount;
				const segmentIndex = Math.min(Math.floor(key / segmentSize), segmentCount - 1);
				const segmentKey = (key - segmentIndex * segmentSize) / segmentSize;
				const startColor = colors[segmentIndex];
				const endColor = colors[segmentIndex + 1];
				const r = Math.round(startColor.r + (endColor.r - startColor.r) * segmentKey);
				const g = Math.round(startColor.g + (endColor.g - startColor.g) * segmentKey);
				const b = Math.round(startColor.b + (endColor.b - startColor.b) * segmentKey);

				const toHex = (c) => {
					const hex = c.toString(16);
					return hex.length === 1 ? "0" + hex : hex;
				};
				
				el_.style.backgroundColor = `#${toHex(r)}${toHex(g)}${toHex(b)}`;
			}
		}
	}
}

function AddElementToInventory(id){
	if(!OpenElements[id]){
		var name = ElementsDatas[id]["Name"];
		var scale = CompactElements > 0 ? 1 : ElementsDatas[id]["Scale"] || 1;
		var shadow = ElementsDatas[id]["Shadow"] || true;
		var content = `<img ${ElementsDatas[id]["Class"] == null || EnableClasses > 0 ? "" : "class=\"" + ElementsDatas[id]["Class"] + "\""} style="width:50px; height:50px; border-radius: 20%" draggable="false" onerror="this.src='alchemy/dev.png';" src="alchemy/${id}.${ElementsDatas[id]["Gif"] == true ? "gif" : "png" }">`;
		if(CompactElements > 0){
			function getcolor(){
				var hash = 0;
				for (var i = 0; i < name.length; i++) {
					hash = name.charCodeAt(i) + ((hash << 5) - hash);
				}
				const color_ = (hash & 0x00FFFFFF).toString(16).toUpperCase();
				return "#" + "0".repeat(6 - color_.length) + color_;
			}
			const color = getcolor();
		
			var fontscale = 4.0 / name.length;
			content = `<div id="${id}-COMPACTICON" style="width:50px; height:50px; border-radius: 20%; background-color: ${color}; overflow:hidden; display: flex; justify-content: center; align-items: center; text-align: center; word-wrap: break-word; overflow-wrap: break-word; font-size:${fontscale}em; text-shadow: -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white, 1px 1px 0 white;">${name}</div>`;
		}
		
		var result = 
		`<div id="got" class="elementbase" elementid="${id}" title="${name}">
			<div class="element" style="z-index: ${500 - Object.keys(OpenElements).length}; ${shadow ? "filter: drop-shadow(0px 0px 2.5px rgba(0,0,0,0.5));" : ""}">
				<img id="${id}_END"  src="alchemy/that_end2.png" style="position:fixed; width:50px; height:50px; z-index:10; pointer-events:none; display:none;">
				<img id="${id}_END2" src="alchemy/that_end.png" style="position:fixed; width:50px; height:50px; z-index:10; pointer-events:none; display:none;">
				<div style="position:fixed; width:50px; height:50px; pointer-events:none; transform: scale(${scale});">
					${content}
				</div>
			</div>
		</div>`;
		document.getElementById("inventory").innerHTML += result;
		OpenElements[id] = Object.keys(OpenElements).length + 1;
		document.getElementById("open-elements").innerText = Object.keys(OpenElements).length;
		if(sort_alphaphyte){
			SortAlphaphyte();
		}
		ApplySearch();
		
		RefreshElementsInInventory();
	}
	var hascraft = false;
	for(var recipe in RecipesDatas){
		var elements = recipe.split("+");
		if(elements[0] == id || elements[1] == id){
			hascraft = true;
		}
	}
	if(hascraft === false && ShowClosedElements){
		document.getElementById(`${id}_END`).style.display = "unset";
	}
}

function LOADOTHERSCRIPT(){

	document.getElementById("total-elements").innerText = AlchemyElements.length;
	document.getElementById("total-recipes").innerText = AlchemyRecipes.length;

	sortedalp = AlchemyElements.sort((a,b) => a.Name.localeCompare(b.Name));

	for(var eldata of AlchemyElements){
		ElementsDatas[eldata["ID"]] = eldata;
	}

	for(var recipe of AlchemyRecipes){
		var craft = recipe.split("=");
		RecipesDatas[craft[0]] = craft[1].split(",");
	}

	if(DevMode){
		var wetrecipesresult = "";
		
		let values = {};
		var AlchemyRecipesWet_ = [];
		var error = false;
		for (let str of AlchemyRecipesWet) {
			str = str.toLowerCase();
			let parts = str.split("=");
			let parts2 = parts[0].split("+");

			if(!ElementsDatas[parts2[0]] && !/\{.*\}/.test(parts2[0])){
				error = `РЕЦЕПТ (${str}) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ПЕРВЫЙ ЭЛЕМЕНТ (${parts2[0]}) НЕИЗВЕСТЕН!`;
			}
			if(!ElementsDatas[parts2[1]] && !/\{.*\}/.test(parts2[1])){
				error = `РЕЦЕПТ (${str}) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ВТОРОЙ ЭЛЕМЕНТ (${parts2[1]}) НЕИЗВЕСТЕН!`;
			}
			var results = parts[1].split(",");
			for(var result of results){
				if(ElementsDatas[result]==null){
					error = `РЕЦЕПТ (${str}) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ ЭЛЕМЕНТ ИЗ РЕЗУЛЬТАТА (${result}) НЕИЗВЕСТЕН!`;
				}
			}
			
			var recipe1 = `${parts2[0]}+${parts2[1]}`;
			var recipe2 = `${parts2[0]}+${parts2[1]}`;
			if (values[recipe1] || values[recipe2]) {
				var val = (!values[recipe1] ? values[recipe2] : values[recipe1]);
				error = `РЕЦЕПТ (${str}) НЕ МОЖЕТ БЫТЬ ДОБАВЛЕН, ПОСКОЛЬКУ УЖЕ ЕСТЬ РЕЦЕПТ (${val})!`;
			} else {
				values[recipe1] = str;
				if(error == false){
					AlchemyRecipesWet_.push(str);
				}
			}
			
			if(error !== false){
				document.getElementById("error").style.display = "unset";
				console.warn(`РЕЦЕПТ: ${error}`);
				if(document.getElementById("error-text").innerHTML == ""){
				   document.getElementById("error-text").innerHTML = error;
				}
			}
		}
		
		var wetrecipes = [];
		var t = 0;
		var t_max = 32;
		for(var wetrecipe of AlchemyRecipesWet_){
			var recipe = wetrecipe.split("=");
			var elements = recipe[0].split("+");
			var el1 = elements[0];
			var el2 = elements[1];
			var result = recipe[1].split(",")
			
			var el1_group = /\{.*\}/.test(el1);
			var el2_group = /\{.*\}/.test(el2);
			if(el1_group || el2_group){
				var el1_   = (el1_group ? el1.slice(1,-1) : el1);
				var el2_   = (el2_group ? el2.slice(1,-1) : el2);
				var group1 = (el1_group ? AlchemyGroups[el1_] : [el1]);
				var group2 = (el2_group ? AlchemyGroups[el2_] : [el2]);
				for(var x of group1){
					for(var y of group2){
						wetrecipes.push(`${x}+${y}=${recipe[1]}`);
					}
				}
			}else{
				wetrecipes.push(wetrecipe);
			}
		}
		
		var recipes_ = {};
		for(var recipe of wetrecipes){
			var r = recipe.split("=");
			var elements = r[0].split("+");
			if(!recipes_[r[0]] && !recipes_[`${elements[1]}+${elements[0]}`]){
				recipes_[r[0]] = r[1];
			}
		}
		
		var keys = Object.keys(recipes_);
		/*for (var i = keys.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = keys[i];
			keys[i] = keys[j];
			keys[j] = temp;
		}*/
		
		for(var i = 0; i < keys.length; i++){
			var key = keys[i];
			var val = recipes_[key];
			t++;
			wetrecipesresult += `"${key}=${val}",${t >= t_max ? "\n" : ""}`;
			if(t >= t_max){ t = 0;}
		}
		
		if(error !== false){
			document.getElementById("generated-recipes").innerHTML = "ОШИБКА ПРИ КОМПИЛЯЦИИ...";
		}else{
			document.getElementById("generated-recipes").innerHTML = wetrecipesresult.slice(0, -1) + "\n";
		}
	}

}
</script>

<script>
var thatLocalFile = window.location.protocol === "file:";
var script = document.createElement("script");
script.src = ".\\alchemy\\alchemy.js";
script.onload = function(){
	LOADOTHERSCRIPT();
}
document.head.appendChild(script);
</script>
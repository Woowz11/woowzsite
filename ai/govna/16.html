<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–õ–∏—Ç—É–∏–∑–º –ú—É–∑—ã–∫–∞ & –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –†–µ–º–∏–∫—Å</title>
<style>
  body {
    margin: 0; background: black; color: #ff3300; font-family: 'Courier New', monospace;
    user-select: none;
  }
  #container {
    display: flex; flex-direction: column; align-items: center; padding: 15px;
  }
  textarea, input[type=text] {
    width: 90%; max-width: 600px; font-size: 18px; padding: 8px; margin: 10px 0;
    background: #220000; border: 2px solid #ff3300; color: #ff3300;
  }
  button, select {
    font-size: 18px; padding: 10px 15px; margin: 5px; background: #330000;
    border: 2px solid #ff3300; color: #ff3300; cursor: pointer;
  }
  button:hover, select:hover { background: #440000; }
  canvas {
    margin-top: 20px; background: black; border: 2px solid #ff3300;
    max-width: 90vw; max-height: 60vh; display: block;
  }
  #effects {
    margin-top: 10px;
  }
  label {
    font-weight: bold;
  }
</style>
</head>
<body>
  <div id="container">
    <h1>üé∏ –õ–∏—Ç—É–∏–∑–º –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –†–µ–º–∏–∫—Å–µ—Ä + –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è üé®</h1>
    <label for="fileInput">–ó–∞–≥—Ä—É–∑–∏—Ç—å MP3 —Ñ–∞–π–ª:</label>
    <input type="file" id="fileInput" accept="audio/mpeg, audio/mp3" />
    <label for="unicodeInput">–í–≤–µ–¥–∏—Ç–µ Unicode —Å–∏–º–≤–æ–ª—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º—É–∑—ã–∫–∏:</label>
    <textarea id="unicodeInput" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ª–∏—Ç—É–∏–º—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã, ùïØùñîùñìùñô ùñòùñôùñîùñï, ‚ú®‚ö°üî•"></textarea>
    
    <div id="effects">
      <label for="effectSelect">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç —Ä–µ–º–∏–∫—Å–∞:</label>
      <select id="effectSelect">
        <option value="clean">–ß–∏—Å—Ç—ã–π –∑–≤—É–∫ (Clean)</option>
        <option value="delay">–≠—Ö–æ (Delay)</option>
        <option value="distortion">–ò—Å–∫–∞–∂–µ–Ω–∏–µ (Distortion)</option>
        <option value="lowpass">–§–∏–ª—å—Ç—Ä –ù–∏–∑–∫–∏—Ö –ß–∞—Å—Ç–æ—Ç (Lowpass)</option>
      </select>
      <button id="playBtn">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
      <button id="stopBtn">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <canvas id="canvas" width="800" height="400"></canvas>
  </div>

<script>
(() => {
  'use strict';

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let audioBuffer = null;
  let sourceNode = null;
  let effectNode = null;
  let analyser = null;
  let animationId = null;

  const fileInput = document.getElementById('fileInput');
  const unicodeInput = document.getElementById('unicodeInput');
  const effectSelect = document.getElementById('effectSelect');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
  fileInput.addEventListener('change', async (e) => {
    if (e.target.files.length === 0) return;
    const file = e.target.files[0];
    if (!file.type.startsWith('audio')) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ MP3.');
      return;
    }
    try {
      const arrayBuffer = await file.arrayBuffer();
      audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      console.log('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω');
    } catch(err) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞—É–¥–∏–æ: ' + err.message);
    }
  });

  // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø–æ –≤—ã–±–æ—Ä—É
  function createEffect(type) {
    if (!audioCtx) return null;
    switch(type) {
      case 'delay':
        const delay = audioCtx.createDelay();
        delay.delayTime.value = 0.3;
        const feedback = audioCtx.createGain();
        feedback.gain.value = 0.5;
        delay.connect(feedback);
        feedback.connect(delay);
        return { input: delay, output: feedback };
      case 'distortion':
        const distortion = audioCtx.createWaveShaper();
        function makeDistortionCurve(amount) {
          const k = typeof amount === 'number' ? amount : 50,
            n_samples = 44100,
            curve = new Float32Array(n_samples);
          for (let i = 0; i < n_samples; ++i) {
            const x = i * 2 / n_samples - 1;
            curve[i] = ((3 + k) * x * 20 * Math.PI / 180) / (Math.PI + k * Math.abs(x));
          }
          return curve;
        }
        distortion.curve = makeDistortionCurve(400);
        distortion.oversample = '4x';
        return distortion;
      case 'lowpass':
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 800;
        return filter;
      case 'clean':
      default:
        return null;
    }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ—Ç –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤ Unicode ‚Äî –ø–æ –∫–æ–¥—É —Å–∏–º–≤–æ–ª–∞ —Å–æ–∑–¥–∞—ë–º —á–∞—Å—Ç–æ—Ç—É
  function generateFrequenciesFromText(text) {
    // –í–æ–∑—å–º—ë–º –º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
    const maxChars = 50;
    const chars = [...text].slice(0, maxChars);
    const freqs = chars.map(c => {
      // Unicode code point -> —á–∞—Å—Ç–æ—Ç–∞ (–æ—Ç 200 –¥–æ 1200 –ì—Ü)
      const code = c.codePointAt(0);
      return 200 + (code % 1000) * 1.0; // –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã
    });
    return freqs;
  }

  // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –ø–æ –º–∞—Å—Å–∏–≤—É —á–∞—Å—Ç–æ—Ç
  function createOscillators(freqs) {
    const oscillators = [];
    const now = audioCtx.currentTime;
    freqs.forEach((freq, i) => {
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, now);
      oscillators.push(osc);
    });
    return oscillators;
  }

  // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º —Ä–µ–º–∏–∫—Å: –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ –∏ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤
  function playRemix() {
    if (!audioBuffer) {
      alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª!');
      return;
    }

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
    stopRemix();

    sourceNode = audioCtx.createBufferSource();
    sourceNode.buffer = audioBuffer;

    const effectType = effectSelect.value;
    effectNode = createEffect(effectType);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;

    // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
    const freqs = generateFrequenciesFromText(unicodeInput.value);
    const oscillators = createOscillators(freqs);

    // –ú–∏–∫—à–µ—Ä –¥–ª—è –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤
    const oscGain = audioCtx.createGain();
    oscGain.gain.value = 0.15;

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
    oscillators.forEach(osc => {
      osc.connect(oscGain);
      osc.start();
      // –æ—Å—Ç–∞–Ω–æ–≤–∏–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª
      osc.stop(audioCtx.currentTime + 10);
    });

    // –°–æ–µ–¥–∏–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏: –∞—É–¥–∏–æ + –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã -> —ç—Ñ—Ñ–µ–∫—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å) -> –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä -> –≤—ã–≤–æ–¥
    if (effectNode) {
      if (effectNode.input && effectNode.output) {
        sourceNode.connect(effectNode.input);
        oscGain.connect(effectNode.input);
        effectNode.output.connect(analyser);
      } else {
        sourceNode.connect(effectNode);
        oscGain.connect(effectNode);
        effectNode.connect(analyser);
      }
    } else {
      sourceNode.connect(analyser);
      oscGain.connect(analyser);
    }
    analyser.connect(audioCtx.destination);

    sourceNode.start();

    drawVisualizer();

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(stopRemix, 10000);
  }

  function stopRemix() {
    if (sourceNode) {
      try {
        sourceNode.stop();
      } catch {}
      sourceNode.disconnect();
      sourceNode = null;
    }
    if (effectNode) {
      try {
        effectNode.disconnect();
      } catch {}
      effectNode = null;
    }
    if (analyser) {
      try {
        analyser.disconnect();
      } catch {}
      analyser = null;
    }
    if(animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
    clearCanvas();
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Å—Ç–∏–ª–µ –ª–∏—Ç—É–∏–∑–º–∞: —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –∫—Ä–∞—Å–Ω—ã–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—è —Å –∫–æ–ª–µ–±–∞–Ω–∏—è–º–∏ –∞–º–ø–ª–∏—Ç—É–¥—ã
  function drawVisualizer() {
    if (!analyser) return;

    const width = canvas.width;
    const height = canvas.height;

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);

    clearCanvas();

    // –§–æ–Ω - —Ö–∞–æ—Ç–∏—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Å—Ç–∏–ª–µ –ª–∏—Ç—É–∏–∑–º–∞
    const text = unicodeInput.value || '‚ö°üî•üíÄ‚ò†Ô∏èüõ†Ô∏è‚öôÔ∏è';
    const chars = [...text.length ? text : '‚ö°üî•üíÄ‚ò†Ô∏èüõ†Ô∏è‚öôÔ∏è'];
    const fontSize = 18;
    ctx.font = `${fontSize}px Courier New`;
    ctx.fillStyle = '#ff3300';

    // –†–∏—Å—É–µ–º —Å–∏–º–≤–æ–ª—ã —Ä–∞–Ω–¥–æ–º–Ω–æ
    for (let i = 0; i < 100; i++) {
      const x = Math.random() * width;
      const y = Math.random() * height;
      const char = chars[Math.floor(Math.random() * chars.length)];
      ctx.globalAlpha = 0.1 + 0.4 * Math.random();
      ctx.fillText(char, x, y);
    }

    // –†–∏—Å—É–µ–º –≤–æ–ª–Ω—ã —á–∞—Å—Ç–æ—Ç
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#ff2200';
    ctx.beginPath();

    for(let i=0; i < bufferLength; i++) {
      const barHeight = dataArray[i];
      const x = (i / bufferLength) * width;
      const y = height - barHeight * 1.5;
      if(i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ - —Å–ª—É—á–∞–π–Ω—ã–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∏–≥—É—Ä—ã —Å –ø—É–ª—å—Å–∞—Ü–∏–µ–π –ø–æ –∞–º–ø–ª–∏—Ç—É–¥–µ
    for(let i=0; i < 15; i++) {
      const amp = dataArray[i*4] / 255;
      ctx.globalAlpha = 0.6 * amp;
      ctx.fillStyle = `rgba(255, 51, 0, ${amp})`;
      const size = 10 + 30 * amp;
      const x = (i * 50 + (Date.now() / 50) % 50) % width;
      const y = height / 2 + 50 * Math.sin(Date.now()/300 + i);
      ctx.beginPath();
      ctx.arc(x, y, size, 0, 2*Math.PI);
      ctx.fill();
    }

    ctx.globalAlpha = 1;
    animationId = requestAnimationFrame(drawVisualizer);
  }

  playBtn.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    playRemix();
  });

  stopBtn.addEventListener('click', () => {
    stopRemix();
  });

  window.addEventListener('unload', () => {
    stopRemix();
    audioCtx.close();
  });
})();
</script>

</body>
</html>

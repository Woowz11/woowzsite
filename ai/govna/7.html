<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üî¥ –õ–∏—Ç—É–∏–º—Å–∫–∞—è –ì–µ–Ω–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: monospace;
      overflow: hidden;
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    #canvas {
      display: block;
    }
    input, button {
      margin: 5px;
      background: red;
      border: none;
      color: white;
      padding: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="ui">
    <input type="text" id="seedInput" placeholder="–≤–≤–µ–¥–∏ –ª–∏—Ç—É–∏–º—Å–∫–∏–π —Å–∏–¥" />
    <input type="range" id="speedInput" min="0.2" max="2" step="0.01" value="1">
    <button onclick="start()">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <button onclick="download()">üéµ –°–∫–∞—á–∞—Ç—å MP4</button>
  </div>
  <canvas id="canvas"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = innerWidth;
    canvas.height = innerHeight;

    let particles = [];
    let seed = "default";
    let speed = 1;
    let audioCtx, osc, analyser, gainNode;

    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function seededRandom(seed) {
      let x = Math.sin(seed++) * 10000;
      return x - Math.floor(x);
    }

    function start() {
      seed = document.getElementById("seedInput").value || "default";
      speed = parseFloat(document.getElementById("speedInput").value || "1");
      const seedNum = hashString(seed);
      initAudio(seedNum);
      particles = [];
    }

    function initAudio(seedNum) {
      if (audioCtx) audioCtx.close();
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      const data = new Uint8Array(analyser.frequencyBinCount);

      osc = audioCtx.createOscillator();
      osc.type = ['sine', 'square', 'sawtooth', 'triangle'][seedNum % 4];
      osc.frequency.value = 220 + (seedNum % 200);

      let lfo = audioCtx.createOscillator();
      let lfoGain = audioCtx.createGain();
      lfo.frequency.value = 1 + (seededRandom(seedNum) * 5);
      lfoGain.gain.value = 100 * speed;

      lfo.connect(lfoGain).connect(osc.frequency);

      gainNode = audioCtx.createGain();
      gainNode.gain.value = 0.3;

      osc.connect(analyser).connect(gainNode).connect(audioCtx.destination);
      lfo.start();
      osc.start();

      function animate() {
        analyser.getByteFrequencyData(data);
        renderFrame(data, seedNum);
        requestAnimationFrame(animate);
      }

      animate();
    }

    class Particle {
      constructor(x, y, freq, color) {
        this.x = x;
        this.y = y;
        this.freq = freq;
        this.color = color;
        this.r = 3 + seededRandom(freq * 1000) * 5;
        this.angle = Math.random() * Math.PI * 2;
        this.speed = 1 + seededRandom(freq * 3000) * 3;
      }
      update() {
        this.x += Math.cos(this.angle) * this.speed * speed;
        this.y += Math.sin(this.angle) * this.speed * speed;
        this.r *= 0.99;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
      }
    }

    function renderFrame(data, seedNum) {
      ctx.fillStyle = 'rgba(0,0,0,0.2)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      data.forEach((val, i) => {
        if (val > 100 && Math.random() < 0.05 * speed) {
          const freq = i / data.length;
          const hue = (seedNum + i * 10) % 360;
          const col = `hsl(${hue}, 100%, 60%)`;
          particles.push(new Particle(canvas.width / 2, canvas.height / 2, freq, col));
        }
      });

      particles = particles.filter(p => p.r > 0.5);
      for (let p of particles) {
        p.update();
        p.draw();
      }
    }

    function download() {
      const stream = canvas.captureStream(30);
      const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      const chunks = [];

      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "litumusic.mp4";
        a.click();
      };

      recorder.start();
      setTimeout(() => recorder.stop(), 10000); // 10 —Å–µ–∫—É–Ω–¥
    }

    start(); // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
  </script>
</body>
</html>

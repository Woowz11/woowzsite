<!DOCTYPE html>
<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="source/griffer.ico">
		<title>GitExplorer</title>
	<style>

html{
	font-family: cursive;
}

body{
	margin				: 0		 ;
	padding			 : 0		 ;
	height				: 100%	;
	display			 : flex	;
		flex-direction: column;
}

	</style>
</head>
<body id="body"></body>

<script>
const Body = document.getElementById("body");

//---------------------------------------

var CurrentScale = 1;

//---------------------------------------

function ScreenAddition(){
	return `<div id="canvases" style="${DEBUG_SaveCanvas?"":"display:none;"}"></div>`;
}

function Screen_Start(){
	var Content = 
`<input type="text" id="repo" placeholder="Ссылка на репозиторий" value="https://github.com/Woowz11/GitExplorer-test">
<button onclick="OpenRepo();">Начать</button>`;
	Body.innerHTML = Content + ScreenAddition();
}

function Screen_Explorer(){
	var Content = 
`<style>
.NotExplorer{
	height: 125px;
}

.Explorer{
	height: calc(100vh - 125px);
}

.Middle{
	height: calc(100% - 4em);
	display: flex;
	overflow: hidden;
}
.Bottom{
	height: 2em; 
	display: flex;
	align-items: center;
	padding-left : 7px;
	padding-right: 7px;
	background-color:rgb(128,128,128);
}
.Left{
	width: 300px;
	transition: width 0.3s ease;
}
.Right{
	width  : calc(100% - 300px);
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(${CurrentScale*150}px, 1fr));
	grid-template-rows	 : repeat(auto-fill, ${CurrentScale*200}px); 
	gap: ${10*CurrentScale}px;
	padding: 10px;
	transition: width 0.3s ease;
	overflow-x: hidden;
	overflow-y: auto;
	background-color:rgba(0,0,0,0.2);
}
.Top{
	display: flex;
	height: 2em;
	align-items: center;
	background-color:rgba(0,0,0,0.2);
}

.DoCenter{
	margin-left : auto;
	margin-right: auto;
}

.File{
	height: ${CurrentScale*200}px;
	box-sizing: border-box;
	display: flex;
	flex-direction: column;
	align-items: center;
}

.FileIcon{
	margin-bottom: 2.5px;
}

.FileName{
	font-size: ${CurrentScale}em;
	word-wrap: break-word;
}

.FileIcon_IMG{
	width: 100%;
	height: auto;
}

.Path{
	width: 100%;
	height: 1.5em;
	background-color:rgba(0,0,0,0.2);
}

@media (max-width: 700px) {
	.Left{
		width: 0%;
	}
	.Right{
		width: 100%;
	}
}

@media (max-height: 156px) {
	.Middle{
		display: none;
	}
	.NotExplorer{
		height: calc(100vh - 2em);
	}
	.Explorer{
		height: calc(100vh - (100vh - 2em));
	}
}
</style>
<div class="NotExplorer"><button onclick="StartScreen();">Новый репозиторий</button></div>
<div class="Explorer">
	<div class="Top">
		<button id="button-undo"><-</button>
		<button id="button-return">-></button>
		<button id="button-parent">/\\</button>
		<div class="DoCenter" style="width:100%; margin-left:5px; margin-right:5px;">
			<div class="Path" id="Path"></div>
		</div>
		<input type="text">
	</div>
	<div class="Middle">
		<div class="Left"></div>
		<div class="Right" id="explorer-content"></div>
	</div>
	<div class="Bottom">
		Элементов: <t id="bottom-elements-count">?</t>
		<div class="DoCenter">
			CENTER
		</div>
		<input type="range" id="bottom-scale" min="0" max="100" value="${CurrentScale*75}">
	</div>
</div>`;
	Body.innerHTML = Content + ScreenAddition();
	
	document.getElementById("bottom-scale").addEventListener("input", function() {
		CurrentScale = Math.max(0.01,this.value/75);
		document.querySelectorAll(".File"		).forEach(File => { File.style.height = `${CurrentScale*200}px`; });
		document.querySelectorAll(".FileName").forEach(Name => { Name.style.fontSize = `${CurrentScale}em`; });
		var qS_R = document.querySelector(".Right");
		qS_R.style.gridTemplateColumns = `repeat(auto-fill, minmax(${CurrentScale*150}px, 1fr))`;
		qS_R.style.gridTemplateRows	   = `repeat(auto-fill, ${CurrentScale*200}px)`;
		qS_R.style.gap                 = `${10*CurrentScale}px`;
	});
}

//---------------------------------------

function StartScreen(){
	Screen_Start();
}

var AllFiles = null;
var CurrentFile = -1;
var CurrentRepoName = null;
async function OpenRepo(){
	const RepoURL = document.getElementById("repo").value;
	try{
		if(!RepoURL){ throw new Error("Не указан репозиторий!"); }
		const RepoURL_Parts = RepoURL.split('/');
		if(RepoURL_Parts.length < 5 || RepoURL_Parts[2] !== "github.com"){ throw new Error("Неверно указана ссылка репозитория!"); }
		
		const Owner = RepoURL_Parts[3];
		const Repo	= RepoURL_Parts[4];
		const API	= `https://api.github.com/repos/${Owner}/${Repo}/git/trees/main?recursive=1`;
		CurrentRepoName = Owner + " : " + Repo;
		
		try{
			const Response = await fetch(API);
			if(!Response.ok){ throw new Error("Не получилось response!"); }
			AllFiles = await Response.json();
			AllFiles = AllFiles.tree;
			await Open(null);
		}catch(error){
			throw new Error("Не получилось получить файлы: " + error);
		}
	}catch(error){
		alert("Не получилось открыть репозиторий: " + error);
	}
}

var TotalPathButtons = 0;
async function GoTo(Data){
	Screen_Explorer();
	TotalPathButtons = 0;
	
	const PathElement = document.getElementById("Path");
	function CreatePathButton(File){
		TotalPathButtons++;
		var PathName = !File ? CurrentRepoName : File.path.split('/').pop();
		var Button = `<button id="path-button-${TotalPathButtons}" onclick="Open(${TotalPathButtons});">${PathName}</button>`;
		PathElement.innerHTML += Button;
	}
	CreatePathButton(null);
	var P = "";
	if(CurrentFile){
		for(const Path of CurrentFile.path.split('/')){
			if(P){ P += "/"; }
			P += Path;
			CreatePathButton(AllFiles.find(item => item.path === P));
		}
	}
	
	document.getElementById("button-parent").addEventListener("click",function(){
		Open(TotalPathButtons-1);
	});
	
	const ShowFileAsync = (File) => {
		return new Promise((resolve) => {
			requestAnimationFrame(() => {
				ShowFile(File);
				resolve();
			});
		});
	};
	
	await Promise.all(Data.map(File => ShowFileAsync(File)));
	
	document.getElementById("bottom-elements-count").innerText = Data.length;
}

function FilterFiles(Files){
	return [...Files].sort((a,b) => {
		if (a.type === "tree" && b.type !== "tree") {
            return -1;
        }
        if (a.type !== "tree" && b.type === "tree") {
            return 1;
        }
        return 0;
	});
}

async function Open(File){
	if((!File || (File && Number.isInteger(File) && File <= 1)) && CurrentFile){ CurrentFile = null; await GoTo(FilterFiles(AllFiles).filter(item => !item.path.includes('/'))); return; }
	if(Number.isInteger(File)){
		if(File!==TotalPathButtons){
			var P = "";
			var i = 0;
			for(const Path of CurrentFile.path.split('/')){
				i++;
				if(i>=File){break;}
				if(P){ P += "/"; }
				P += Path;
			}
			Open(AllFiles.find(item => item.path === P));
		}
	}else{
		if(File.type==="tree"){
			try{
				var Data = FilterFiles(AllFiles).filter(item => {
					return item.path.includes(File.path + "/") && item.path.split('/').length === File.path.split('/').length+1;
				});
				CurrentFile = File;
				await GoTo(Data);
			}catch(error){
				alert("Не получилось открыть директорию: " + error)
			}
		}else{
		
		}
	}
}

//---------------------------------------

async function ShowFile(File){
	const Div = document.createElement("div");
	Div.className = "File";
	Div.id		  = File.sha;
	
	const Icon = document.createElement("t");
	Icon.className = "FileIcon";
	Icon.id		   = "file-icon";
	Icon.innerHTML = `<img class="FileIcon_IMG" loading="lazy" src="${File.type==="tree"?UnknownFImage:UnknownImage}">`;
	
	const Name = document.createElement("t");
	Name.className   = "FileName";
	Name.id		     = "file-name";
	Name.textContent = File.path.split('/').pop();
	
	Div.appendChild(Icon);
	Div.appendChild(Name);
	
	Div.addEventListener("click",function(){
		Open(File);
	});
	
	document.getElementById("explorer-content").appendChild(Div);
	
	const FastIcon = await GetIcon(File,false);

	Icon.innerHTML = `<img class="FileIcon_IMG" src="${FastIcon}">`;
	
	//const ExtendIcon = await GetIcon(File,true);
	
	//Icon.innerHTML = `<img class="FileIcon_IMG" src="${ExtendIcon}">`;
}

async function GetIcon(File,Extend){
	if(!Extend){
		if(File.type==="tree"){ return await GenerateFastFolder(File); }
		return FileImage;
	}else{
		return "source/empty.png";
	}
}

async function ShowFile_Extend(File){

}

//---------------------------------------

const DEBUG_SaveCanvas = true;
const IconSize = 512;
const ErrorImage = "source/error-image.png";
const FileImage	= "ge/file.png";
const UnknownImage	= "ge/file_unknown.png";
const UnknownFImage	= "ge/folder_unknown.png";

async function GenerateFastFolder(File){
	try{
		const C = GenerateCanvas(IconSize,IconSize);
		const c = C.getContext("2d");
		
		c_OverImage(c,await GetImage("https://woowz11.github.io/woowzsite/ge/folder_bottom.png"),0,0);
		
		const RandColors = [0,117,-124];
		const RandBright = [0,75 ,-75 ];
		
		const ColorRands = await GetRandomNumbersFromSha(File.sha, 6);
		
		var Color1 = await GetImage("https://woowz11.github.io/woowzsite/ge/folder_bottom_marker1.png");
		var Color2 = await GetImage("https://woowz11.github.io/woowzsite/ge/folder_bottom_marker2.png");
		var Color3 = await GetImage("https://woowz11.github.io/woowzsite/ge/folder_bottom_marker3.png");
		
		if(ColorRands[0]>0.5){Color1 = i_ChangeHue(Color1,RandColors[Math.floor(ColorRands[3] * RandColors.length)]);}else{Color1 = i_Brightness(i_ToGray(Color1),RandBright[Math.floor(ColorRands[3] * RandBright.length)]);}
		if(ColorRands[1]>0.5){Color2 = i_ChangeHue(Color2,RandColors[Math.floor(ColorRands[4] * RandColors.length)]);}else{Color2 = i_Brightness(i_ToGray(Color2),RandBright[Math.floor(ColorRands[4] * RandBright.length)]);}
		if(ColorRands[2]>0.5){Color3 = i_ChangeHue(Color3,RandColors[Math.floor(ColorRands[5] * RandColors.length)]);}else{Color3 = i_Brightness(i_ToGray(Color3),RandBright[Math.floor(ColorRands[5] * RandBright.length)]);}
		
		c_OverImage(c,Color1,0,0);
		c_OverImage(c,Color2,0,0);
		c_OverImage(c,Color3,0,0);
		
		c_OverImage(c,await GetImage("https://woowz11.github.io/woowzsite/ge/folder_top.png"),0,0);
		
		var Result = C.toDataURL();
		ClearCanvas(C);
		return Result;
	}catch(error){
		console.error("Не получилось GenerateFastFolder: " + error);
		return ErrorImage;
	}
}

function i_ChangeHue(I,v){
	const data = I.data;
	for (let i = 0; i < data.length; i += 4) {
		let r = data[i];
		let g = data[i + 1];
		let b = data[i + 2];

		let [h, s, l] = rgbToHsl(r, g, b);

		h = (h + v) % 360;

		[r, g, b] = hslToRgb(h, s, l);

		data[i] = r;
		data[i + 1] = g;
		data[i + 2] = b;
	}
	return I;
}

function i_ToGray(I){
	const data = I.data;
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];

        const gray = 0.3 * r + 0.59 * g + 0.11 * b;
        data[i] = data[i + 1] = data[i + 2] = gray;
    }
	return I;
}

function i_Brightness(I,v){
	const data = I.data;
    for (let i = 0; i < data.length; i += 4) {
        data[i    ] = Math.min(255, Math.max(0, data[i    ] + v));
        data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + v));
        data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + v));
    }
	return I;
}

function c_OverImage(c,I,x,y){
	try{
		const tC = GenerateCanvas(I.width, I.height);
		const tc = tC.getContext('2d');

		tc.putImageData(I, 0, 0);

		c.drawImage(tC,x,y);
	}catch(error){
		console.error("Не получилось OverImage: " + error);
	}
}

function c_SetImage(c,I,x,y){
	try{
		c.putImageData(I,x,y);
	}catch(error){
		console.error("Не получилось SetImage: " + error);
	}
}

async function GetImage(Path){
	return new Promise((resolve, reject) => {
		const I = new Image();
		I.crossOrigin = "anonymous";
		I.src = Path;

		I.onload = function(){
		const C = GenerateCanvas(I.width,I.height);
		const c = C.getContext("2d");
		c.drawImage(I,0,0,I.width,I.height);
				resolve(c.getImageData(0,0,I.width,I.height));
		};

		I.onerror = function(){
				reject(new Error("Произошла ошибка при загрузке изображения!"));
		};
	}).catch(error => {
			console.error("Не получилось получить изображение [" + Path + "]: " + error);
	});
}

function GenerateCanvas(w,h){
	const C = document.createElement("canvas");
	C.width = w; C.height = h;
	document.getElementById("canvases").appendChild(C);
	return C;
}
function ClearCanvas(C){
	if(!DEBUG_SaveCanvas){
		C.remove();
	}
}

const encoder = new TextEncoder();
async function GetRandomNumbersFromSha(input,n) {
    const data = encoder.encode(input);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));

    const maxValue = Math.pow(2, 32);
	const numbers = [];
	
	for (let i = 0; i < n; i++) {
        const startIndex = i * 4;
        const endIndex = startIndex + 4;
        if (endIndex > hashArray.length) {
            break;
        }
        const num = (hashArray.slice(startIndex, endIndex).reduce((acc, val) => (acc << 8) + val, 0) >>> 0) / maxValue;
        numbers.push(num);
    }

    return numbers;
}

function rgbToHsl(r, g, b) {
	r /= 255;
	g /= 255;
	b /= 255;
	let max = Math.max(r, g, b), min = Math.min(r, g, b);
	let h, s, l = (max + min) / 2;

	if (max == min) {
		h = s = 0;
	} else {
		let d = max - min;
		s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
		switch (max) {
			case r: h = (g - b) / d + (g < b ? 6 : 0); break;
			case g: h = (b - r) / d + 2; break;
			case b: h = (r - g) / d + 4; break;
		}
		h /= 6;
	}

	return [h * 360, s * 100, l * 100];
}
		
function hslToRgb(h, s, l) {
	h /= 360;
	s /= 100;
	l /= 100;
	let r, g, b;

	if (s === 0) {
		r = g = b = l;
	} else {
		const hue2rgb = (p, q, t) => {
			if (t < 0) t += 1;
			if (t > 1) t -= 1;
			if (t < 1 / 6) return p + (q - p) * 6 * t;
			if (t < 1 / 2) return q;
			if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
			return p;
		};

		const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
		const p = 2 * l - q;
		r = hue2rgb(p, q, h + 1 / 3);
		g = hue2rgb(p, q, h);
		b = hue2rgb(p, q, h - 1 / 3);
	}

	return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

//---------------------------------------

StartScreen();

</script>